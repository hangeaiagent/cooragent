# æ—…æ¸¸æ™ºèƒ½ä½“åŸå‹äº§å“æŠ€æœ¯æ€»ç»“0802

## ğŸ“‹ äº§å“æ¦‚è§ˆ

æœ¬æ–‡æ¡£å…¨é¢åˆ†æå½“å‰æ—…æ¸¸å¤šæ™ºèƒ½ä½“åŸå‹äº§å“çš„æŠ€æœ¯æ¶æ„ï¼Œå¯¹æ¯”å‰ç«¯å®ç°ä¸æ ¸å¿ƒå¤šæ™ºèƒ½ä½“å·¥ä½œæµçš„ä¸€è‡´æ€§ï¼Œå¹¶æ€»ç»“åŸºäº **Coordinator â†’ Planner â†’ Publisher â†’ AgentProxy â†’ Factory â†’ Reporter** æ ‡å‡†å·¥ä½œæµè¿›è¡Œçš„æ—…æ¸¸é¢†åŸŸå®šåˆ¶åŒ–ä¿®æ”¹ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„åˆ†æ

### 1. æ ‡å‡†å¤šæ™ºèƒ½ä½“å·¥ä½œæµ

#### **1.1 åŸºç¡€å·¥ä½œæµæ¶æ„**
```mermaid
graph LR
    A[ç”¨æˆ·è¾“å…¥] --> B[Coordinator<br/>åè°ƒå™¨]
    B --> C[Planner<br/>è§„åˆ’å™¨]
    C --> D[Publisher<br/>å‘å¸ƒå™¨]
    D --> E[AgentProxy<br/>æ™ºèƒ½ä½“ä»£ç†]
    E --> F[Factory<br/>æ™ºèƒ½ä½“å·¥å‚]
    E --> G[Reporter<br/>æŠ¥å‘Šå™¨]
    D --> E
    F --> D
    G --> H[æœ€ç»ˆè¾“å‡º]
```

#### **1.2 å„ç»„ä»¶èŒè´£å®šä¹‰**
- **Coordinator**: æ™ºèƒ½åˆ†ç±»å™¨ï¼ŒåŒºåˆ†ç®€å•æŸ¥è¯¢ vs å¤æ‚ä»»åŠ¡
- **Planner**: éœ€æ±‚åˆ†è§£å™¨ï¼Œç”Ÿæˆè¯¦ç»†æ‰§è¡Œè®¡åˆ’å’Œæ™ºèƒ½ä½“é…ç½®
- **Publisher**: ä»»åŠ¡åˆ†å‘å™¨ï¼ŒæŒ‰è®¡åˆ’åˆ†å‘ä»»åŠ¡ç»™ç›¸åº”æ™ºèƒ½ä½“
- **AgentProxy**: æ‰§è¡Œå¼•æ“ï¼Œåˆ›å»ºå’Œç®¡ç†ReActæ™ºèƒ½ä½“å®ä¾‹
- **Factory**: æ™ºèƒ½ä½“åˆ›å»ºå™¨ï¼ŒåŠ¨æ€ç”Ÿæˆä¸“ä¸šåŒ–æ™ºèƒ½ä½“
- **Reporter**: ç»“æœæ±‡æ€»å™¨ï¼Œæ•´åˆæ‰§è¡Œç»“æœç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š

### 2. æ—…æ¸¸æ™ºèƒ½ä½“å®šåˆ¶åŒ–å®ç°

#### **2.1 æ—…æ¸¸ä¸“ç”¨å·¥ä½œæµå¢å¼º**
å½“å‰æ—…æ¸¸äº§å“**å®Œå…¨éµå¾ª**æ ‡å‡†å·¥ä½œæµæ¶æ„ï¼Œä½†åœ¨æ¯ä¸ªç¯èŠ‚éƒ½è¿›è¡Œäº†**é¢†åŸŸä¸“ä¸šåŒ–å®šåˆ¶**ï¼š

```python
# å½“å‰å®ç°çš„å·¥ä½œæµè·¯å¾„
ç”¨æˆ·æ—…æ¸¸éœ€æ±‚ â†’ TravelCoordinator â†’ TravelPlanner â†’ TravelPublisher â†’ TravelAgentProxy â†’ TravelFactory â†’ TravelReporter
```

#### **2.2 å„ç¯èŠ‚çš„æ—…æ¸¸å®šåˆ¶**

##### **TravelCoordinator (åè°ƒå™¨å®šåˆ¶)**
```python
# æ—…æ¸¸ä¸“ç”¨åˆ†ç±»é€»è¾‘
Protocol 1: ç®€å•æ—…æ¸¸ä¿¡æ¯æŸ¥è¯¢
- "åŒ—äº¬æœ‰ä»€ä¹ˆå¥½ç©çš„ï¼Ÿ" â†’ ç›´æ¥å›å¤
- "æ³°å›½ç­¾è¯æ€ä¹ˆåŠï¼Ÿ" â†’ åŸºç¡€ä¿¡æ¯å“åº”

Protocol 2: å¤æ‚æ—…æ¸¸è§„åˆ’ä»»åŠ¡  
- "å¸®æˆ‘è§„åˆ’3å¤©åŒ—äº¬æ·±åº¦æ¸¸" â†’ ç§»äº¤ç»™TravelPlanner
- "åˆ¶å®šæ¬§æ´²7å›½15æ—¥æ¸¸æ”»ç•¥" â†’ å¤æ‚ä»»åŠ¡å¤„ç†

# åœ°ç†æ„ŸçŸ¥è·¯ç”±
- è‡ªåŠ¨è¯†åˆ«å›½å†… vs æµ·å¤–æ—…æ¸¸
- æ™ºèƒ½åˆ‡æ¢MCPå·¥å…·é…ç½®
- é¢„ç®—å’Œæ—¶é—´çº¦æŸåˆ†æ
```

##### **TravelPlanner (è§„åˆ’å™¨å®šåˆ¶)**
```python
# æ—…æ¸¸ä¸“ç”¨è§„åˆ’èƒ½åŠ›æ‰©å±•
class TravelPlanner:
    - åœ°ç†ç©ºé—´ä¼˜åŒ–ï¼šè·¯çº¿è§„åˆ’ã€äº¤é€šè¡”æ¥
    - æ—¶é—´çª—å£ç®¡ç†ï¼šè¥ä¸šæ—¶é—´ã€é¢„è®¢æˆªæ­¢æ—¶é—´  
    - é¢„ç®—æ™ºèƒ½åˆ†é…ï¼šä½å®¿ã€äº¤é€šã€é¤é¥®ã€æ´»åŠ¨
    - å¤©æ°”é€‚åº”è§„åˆ’ï¼šå®¤å†…å¤–æ´»åŠ¨åŠ¨æ€è°ƒæ•´
    - æ–‡åŒ–æ•´åˆï¼šå½“åœ°ä¹ ä¿—ã€èŠ‚åº†æ´»åŠ¨è€ƒè™‘

# è¾“å‡ºç»“æ„å¢å¼º
interface TravelPlan extends StandardPlan {
    destination_analysis: string;       // ç›®çš„åœ°æ·±åº¦åˆ†æ
    budget_breakdown: BudgetItem[];     // é¢„ç®—æ˜ç»†
    itinerary_steps: TravelStep[];      // ä¼˜åŒ–åçš„è¡Œç¨‹æ­¥éª¤
    weather_considerations: string;     // å¤©æ°”å› ç´ è€ƒè™‘
}
```

##### **TravelPublisher (å‘å¸ƒå™¨å®šåˆ¶)**
```python
# æ—…æ¸¸ä»»åŠ¡æ™ºèƒ½åˆ†å‘å¢å¼º
class TravelPublisher:
    - åœ°ç†èšç±»ä¼˜åŒ–ï¼šæŒ‰ä½ç½®å°±è¿‘åˆ†ç»„æ‰§è¡Œ
    - å®æ—¶æ¡ä»¶é€‚åº”ï¼šå¤©æ°”ã€äº¤é€šçŠ¶å†µåŠ¨æ€è°ƒæ•´
    - æ—¶é—´çª—å£éªŒè¯ï¼šç¡®ä¿ä»»åŠ¡åœ¨æœ‰æ•ˆæ—¶é—´å†…æ‰§è¡Œ
    - èµ„æºå†²çªæ£€æµ‹ï¼šé¿å…é¢„è®¢æ—¶é—´å†²çª

# æ™ºèƒ½è·¯ç”±é€»è¾‘ç¤ºä¾‹
if weather_dependent_task and bad_weather:
    â†’ è·³è½¬åˆ°å®¤å†…æ›¿ä»£æ´»åŠ¨
elif booking_urgent and within_business_hours:
    â†’ ä¼˜å…ˆæ‰§è¡Œé¢„è®¢ä»»åŠ¡
elif same_location_tasks:
    â†’ åœ°ç†èšç±»æ‰¹é‡æ‰§è¡Œ
```

##### **TravelAgentProxy (ä»£ç†å®šåˆ¶)**
```python
# æ—…æ¸¸æ™ºèƒ½ä½“æ‰§è¡Œç‰¹æ€§
class TravelAgentProxy:
    - æ—…æ¸¸ä¸Šä¸‹æ–‡æ³¨å…¥ï¼šåœ°ç†ä½ç½®ã€å¤©æ°”ã€é¢„ç®—ä¿¡æ¯
    - MCPå·¥å…·æ™ºèƒ½è°ƒç”¨ï¼šå›½å†…å¤–å·¥å…·è‡ªåŠ¨åˆ‡æ¢
    - å¤šæ¨¡æ€èƒ½åŠ›ï¼šæ”¯æŒæ–‡æœ¬ã€å›¾åƒã€åœ°å›¾ç­‰
    - å®æ—¶ä¿¡æ¯è·å–ï¼šåŠ¨æ€è·å–æœ€æ–°ä»·æ ¼ã€å¯ç”¨æ€§

# ReActæ¨¡å¼æ—…æ¸¸åº”ç”¨ç¤ºä¾‹
User: "å¸®æˆ‘æ‰¾åŒ—äº¬æ€§ä»·æ¯”é«˜çš„é…’åº—"
â†’ Thought: "éœ€è¦æœç´¢åŒ—äº¬é…’åº—ä¿¡æ¯ï¼Œè€ƒè™‘ä»·æ ¼å’Œè¯„ä»·"
â†’ Action: hotel_search_and_booking  
â†’ Observation: "æ‰¾åˆ°10å®¶é…’åº—ï¼Œä»·æ ¼200-800å…ƒ"
â†’ Thought: "åŸºäºä»·æ ¼å’Œè¯„åˆ†ç­›é€‰æœ€ä¼˜é€‰æ‹©"
â†’ Final Answer: "æ¨è3å®¶æ€§ä»·æ¯”æœ€ä¼˜é…’åº—..."
```

##### **TravelFactory (å·¥å‚å®šåˆ¶)**
```python
# æ—…æ¸¸æ™ºèƒ½ä½“ä¸“ä¸šåŒ–åˆ›å»º
class TravelFactory:
    - éœ€æ±‚åˆ†æï¼šè¯†åˆ«ä¸“ä¸šæ—…æ¸¸èƒ½åŠ›ç¼ºå£
    - å·¥å…·ç²¾é€‰ï¼šæ™ºèƒ½é€‰æ‹©æ—…æ¸¸ä¸“ç”¨å·¥å…·ç»„åˆ
    - æç¤ºè¯å·¥ç¨‹ï¼šåˆ›å»ºæ—…æ¸¸é¢†åŸŸä¸“ä¸šè¡Œä¸ºæŒ‡å—
    - åœ°åŸŸé€‚é…ï¼šé’ˆå¯¹ä¸åŒåœ°åŒºåˆ›å»ºæœ¬åœ°åŒ–æ™ºèƒ½ä½“

# æ™ºèƒ½ä½“ç±»å‹è®¾è®¡
ä¸“ä¸šåŒ–æ™ºèƒ½ä½“ç±»å‹ï¼š
- TravelPlannerExpert: ç»¼åˆè¡Œç¨‹è§„åˆ’ä¸“å®¶
- LocalGuide: æœ¬åœ°æ–‡åŒ–å¯¼æ¸¸ä¸“å®¶  
- BudgetOptimizer: æ—…æ¸¸é¢„ç®—ä¼˜åŒ–ä¸“å®¶
- TransportCoordinator: äº¤é€šåè°ƒä¸“å®¶
```

---

## ğŸ’» å‰ç«¯ç•Œé¢å®ç°åˆ†æ

### 1. å‰ç«¯æ¶æ„ä¸å·¥ä½œæµçš„æ˜ å°„å…³ç³»

#### **1.1 APIæ¥å£æ˜ å°„**
```javascript
// å‰ç«¯è°ƒç”¨è·¯å¾„
å‰ç«¯è¡¨å•æäº¤ â†’ /api/generate â†’ æ ‡å‡†å·¥ä½œæµ â†’ æ—…æ¸¸ä¸“ç”¨å¤„ç†

// å…·ä½“å®ç°
fetch('/api/generate', {
    method: 'POST',
    body: JSON.stringify({
        content: travelRequest,     // ç»“æ„åŒ–æ—…æ¸¸éœ€æ±‚
        user_id: 'travel_user_' + Date.now()
    })
})
â†“
// æ˜ å°„åˆ°æ ‡å‡†å·¥ä½œæµ
GeneratorServer._generate() 
â†’ run_agent_workflow()
â†’ Coordinator â†’ Planner â†’ Publisher â†’ AgentProxy â†’ Factory â†’ Reporter
```

#### **1.2 è¿›åº¦è¿½è¸ªä¸å·¥ä½œæµå¯¹åº”**
```javascript
// å‰ç«¯è¿›åº¦é˜¶æ®µä¸åç«¯å·¥ä½œæµçš„å¯¹åº”å…³ç³»
const progressStages = {
    "åˆå§‹åŒ–ä¸­...": "ç³»ç»Ÿå¯åŠ¨ï¼Œå·¥ä½œæµåˆå§‹åŒ–",
    "åˆ†ææ—…æ¸¸éœ€æ±‚...": "Coordinator æ™ºèƒ½åˆ†ç±»",
    "ç”Ÿæˆè¡Œç¨‹è§„åˆ’...": "Planner éœ€æ±‚åˆ†è§£å’Œè§„åˆ’",
    "åˆ›å»ºä¸“ä¸šæ™ºèƒ½ä½“...": "Factory åŠ¨æ€åˆ›å»ºæ—…æ¸¸æ™ºèƒ½ä½“", 
    "æ‰§è¡Œæ—…æ¸¸ä»»åŠ¡...": "AgentProxy æ‰§è¡Œå…·ä½“ä»»åŠ¡",
    "æ•´åˆç»“æœ...": "Reporter æ±‡æ€»ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š",
    "ç”Ÿæˆå®Œæˆï¼": "å·¥ä½œæµå®Œæˆï¼Œè¿”å›ç»“æœ"
};
```

### 2. å‰ç«¯å®ç°çš„æŠ€æœ¯æ ˆåˆ†æ

#### **2.1 æ ¸å¿ƒæŠ€æœ¯æ¶æ„**
```html
<!-- æŠ€æœ¯æ ˆç»„æˆ -->
å‰ç«¯æŠ€æœ¯æ ˆ:
â”œâ”€â”€ HTML5 - è¯­ä¹‰åŒ–ç»“æ„
â”œâ”€â”€ Tailwind CSS - åŸå­åŒ–æ ·å¼æ¡†æ¶  
â”œâ”€â”€ Vanilla JavaScript - åŸç”ŸJSå®ç°
â”œâ”€â”€ Font Awesome - å›¾æ ‡åº“
â””â”€â”€ Fetch API - å¼‚æ­¥HTTPè¯·æ±‚

ç”¨æˆ·ä½“éªŒè®¾è®¡:
â”œâ”€â”€ æ¸å˜èƒŒæ™¯ + æ¯›ç»ç’ƒæ•ˆæœ
â”œâ”€â”€ å“åº”å¼å¸ƒå±€é€‚é…
â”œâ”€â”€ å®æ—¶è¿›åº¦æ˜¾ç¤º
â””â”€â”€ Markdownå¯¼å‡ºåŠŸèƒ½
```

#### **2.2 å…³é”®åŠŸèƒ½å®ç°**
```javascript
// 1. æ™ºèƒ½è¡¨å•å¤„ç†
function buildTravelRequest() {
    return `è¯·å¸®æˆ‘åˆ¶å®šä»${departure}åˆ°${destination}çš„æ—…æ¸¸è®¡åˆ’ã€‚
å‡ºè¡Œæ—¶é—´ï¼š${startDate} è‡³ ${endDate}
å‡ºè¡Œäººæ•°ï¼š${travelers}
é¢„ç®—èŒƒå›´ï¼š${budget}
æ—…è¡Œåå¥½ï¼š${preference}
${specialRequests ? `ç‰¹æ®Šéœ€æ±‚ï¼š${specialRequests}` : ''}

è¯·æä¾›è¯¦ç»†çš„æ—…æ¸¸è§„åˆ’ï¼ŒåŒ…æ‹¬ï¼š
1. å¾€è¿”èˆªç­æ¨èå’Œä»·æ ¼
2. ä½å®¿æ¨èï¼ˆåŒ…å«ä»·æ ¼å’Œä½ç½®ï¼‰
3. æ¯æ—¥è¡Œç¨‹å®‰æ’å’Œæ™¯ç‚¹æ¨è  
4. ç¾é£Ÿæ¨è
5. è¯¦ç»†é¢„ç®—åˆ†æ
6. æ—…è¡Œè´´å£«å’Œæ³¨æ„äº‹é¡¹`;
}

// 2. å®æ—¶çŠ¶æ€è½®è¯¢
async function pollTaskStatus(taskId) {
    const pollInterval = setInterval(async () => {
        const response = await fetch(`/api/generate/${taskId}/status`);
        const data = await response.json();
        
        updateProgress(data.progress, data.stage);
        
        if (data.status === 'completed') {
            clearInterval(pollInterval);
            showResult(generateSampleResult()); // æ˜¾ç¤ºç»“æœ
        }
    }, 2000);
}

// 3. ç»“æœå±•ç¤ºä¸å¯¼å‡º
function exportMarkdown() {
    const content = document.getElementById('resultContent').innerHTML;
    const markdown = convertHtmlToMarkdown(content);
    downloadMarkdownFile(markdown);
}
```

### 3. å‰ç«¯ä¸åç«¯å·¥ä½œæµçš„ä¸€è‡´æ€§åˆ†æ

#### **3.1 å®Œå…¨ä¸€è‡´çš„æ¶æ„è®¾è®¡**
âœ… **å‰ç«¯å®ç°å®Œå…¨éµå¾ªæ ‡å‡†å·¥ä½œæµ**
- å‰ç«¯é€šè¿‡ `/api/generate` è°ƒç”¨æ ‡å‡†å·¥ä½œæµæ¥å£
- æ²¡æœ‰è·³è¿‡æˆ–ä¿®æ”¹æ ¸å¿ƒå·¥ä½œæµç»„ä»¶
- æ‰€æœ‰æ—…æ¸¸å®šåˆ¶éƒ½åœ¨å·¥ä½œæµå†…éƒ¨å®ç°

#### **3.2 æ—…æ¸¸å®šåˆ¶çš„å®ç°æ–¹å¼**
âœ… **é€šè¿‡å†…å®¹å’Œä¸Šä¸‹æ–‡æ³¨å…¥å®ç°å®šåˆ¶**
```javascript
// å‰ç«¯æ„å»ºæ—…æ¸¸ä¸“ç”¨è¯·æ±‚å†…å®¹
const travelRequest = buildStructuredTravelRequest();

// åç«¯å·¥ä½œæµè‡ªåŠ¨è¯†åˆ«æ—…æ¸¸é¢†åŸŸ
if (is_travel_related(request_content)) {
    // æ¿€æ´»æ—…æ¸¸ä¸“ç”¨ç»„ä»¶
    activate_travel_mode();
}
```

#### **3.3 MCPå·¥å…·é›†æˆçš„é€æ˜æ€§**
âœ… **MCPç»„ä»¶è°ƒç”¨å¯¹å‰ç«¯é€æ˜**
```javascript
// å‰ç«¯åªéœ€è¦è°ƒç”¨ç»Ÿä¸€æ¥å£
fetch('/api/generate', {...})

// åç«¯è‡ªåŠ¨å¤„ç†MCPå·¥å…·é€‰æ‹©
if (destination_in_china):
    load_mcp_tools(['amap', 'ctrip', 'dianping'])
else:
    load_mcp_tools(['google_maps', 'booking', 'yelp'])
```

---

## ğŸ”§ MCPç»„ä»¶é›†æˆæŠ€æœ¯å®ç°

### 1. MCPå·¥å…·é…ç½®ä¸ç®¡ç†

#### **1.1 å›½å†…å¤–å·®å¼‚åŒ–é…ç½®**
```json
// config/mcp.json æ™ºèƒ½é…ç½®
{
  "china_travel": {
    "amap": {"url": "https://mcp.amap.com/sse"},
    "ctrip": {"command": "python", "args": ["tools/ctrip_server.py"]}, 
    "dianping": {"command": "node", "args": ["tools/dianping_server.js"]}
  },
  "international_travel": {
    "google_maps": {"url": "https://mcp.google.com/maps"},
    "booking": {"url": "https://mcp.booking.com/sse"},
    "yelp": {"command": "python", "args": ["tools/yelp_server.py"]}
  }
}
```

#### **1.2 æ™ºèƒ½å·¥å…·é€‰æ‹©æœºåˆ¶**
```python
class IntelligentTravelToolOrchestrator:
    """æ™ºèƒ½æ—…æ¸¸å·¥å…·ç¼–æ’å™¨"""
    
    async def get_mcp_client_for_destination(self, destination: str):
        if self._is_china_destination(destination):
            config = self.tool_configs["china"]
            print("ğŸ‡¨ğŸ‡³ Loading China travel MCP configuration")
        else:
            config = self.tool_configs["international"]  
            print("ğŸŒ Loading International travel MCP configuration")
        
        return MultiServerMCPClient(config)
```

### 2. ReActæ¨¡å¼ä¸‹çš„MCPè°ƒç”¨

#### **2.1 MCPå·¥å…·åœ¨å¤§æ¨¡å‹å†…éƒ¨è°ƒç”¨**
```python
# MCPå·¥å…·è°ƒç”¨æ—¶åº
"""
1. å‰ç«¯è¯·æ±‚ â†’ åç«¯æ¥æ”¶
2. Coordinator åˆ†æ â†’ è¯†åˆ«ä¸ºæ—…æ¸¸ä»»åŠ¡
3. Planner è§„åˆ’ â†’ é€‰æ‹©éœ€è¦çš„MCPå·¥å…·
4. AgentProxy åˆ›å»ºReActæ™ºèƒ½ä½“ â†’ ç»‘å®šMCPå·¥å…·
5. ReActå†…éƒ¨æ¨ç†å¾ªç¯ï¼š
   - Thought: "éœ€è¦æŸ¥è¯¢é…’åº—ä¿¡æ¯"
   - Action: hotel_search_and_booking  â† MCPå·¥å…·è°ƒç”¨
   - Observation: "æ‰¾åˆ°5å®¶é…’åº—é€‰é¡¹"
   - Thought: "åŸºäºè¯„ä»·å’Œä»·æ ¼æ¨è"
   - Final Answer: "æ¨èæœ€ä½³é…’åº—"
"""
```

#### **2.2 å·¥å…·è°ƒç”¨çš„æŠ€æœ¯å®ç°**
```python
# src/workflow/coor_task.py: agent_proxy_node()
async def agent_proxy_node(state: State):
    """æ™ºèƒ½ä½“ä»£ç†æ‰§è¡ŒèŠ‚ç‚¹"""
    
    # 1. è·å–æ™ºèƒ½ä½“é…ç½®
    _agent = agent_manager.available_agents[state["next"]]
    
    # 2. ç»„è£…å·¥å…·é“¾ï¼ˆåŒ…å«MCPå·¥å…·ï¼‰
    tools = [
        agent_manager.available_tools[tool.name] 
        for tool in _agent.selected_tools
        # MCPå·¥å…·å·²åœ¨åˆå§‹åŒ–æ—¶åŠ è½½åˆ°available_tools
    ]
    
    # 3. åˆ›å»ºReActæ™ºèƒ½ä½“
    agent = create_react_agent(
        llm=get_llm_by_type(_agent.llm_type),
        tools=tools,  # MCPå·¥å…·ä½œä¸ºæ ‡å‡†å·¥å…·ä¼ å…¥
        prompt=apply_prompt(state, _agent.prompt)
    )
    
    # 4. æ‰§è¡Œä»»åŠ¡ï¼ˆMCPå·¥å…·åœ¨æ¨ç†è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼‰
    response = await agent.ainvoke(state, config=config)
```

---

## ğŸ“Š äº§å“ç‰¹æ€§ä¸æŠ€æœ¯ä¼˜åŠ¿

### 1. æ¶æ„ä¸€è‡´æ€§ä¼˜åŠ¿

#### **1.1 æ ‡å‡†å·¥ä½œæµçš„å®Œæ•´ä¿ç•™**
âœ… **æ— æ¶æ„ç ´åæ€§ä¿®æ”¹**
- ä¿æŒ Coordinator â†’ Planner â†’ Publisher â†’ AgentProxy â†’ Factory â†’ Reporter å®Œæ•´é“¾è·¯
- æ‰€æœ‰å®šåˆ¶éƒ½é€šè¿‡å†…å®¹æ³¨å…¥å’Œé…ç½®å¢å¼ºå®ç°
- ç¡®ä¿ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§

#### **1.2 é¢†åŸŸä¸“ä¸šåŒ–ä¸é€šç”¨æ€§å¹³è¡¡**
âœ… **æ¸è¿›å¼å¢å¼ºè®¾è®¡**
```python
# é€šç”¨å·¥ä½œæµ + æ—…æ¸¸ä¸“ä¸šåŒ–
if is_travel_task(user_input):
    # æ¿€æ´»æ—…æ¸¸ä¸“ç”¨å¢å¼º
    enhance_with_travel_capabilities()
else:
    # ä½¿ç”¨æ ‡å‡†å·¥ä½œæµ
    use_standard_workflow()
```

### 2. æŠ€æœ¯å®ç°ä¼˜åŠ¿

#### **2.1 å‰åç«¯åˆ†ç¦»æ¶æ„**
âœ… **æ¸…æ™°çš„èŒè´£åˆ†å·¥**
- å‰ç«¯ï¼šç”¨æˆ·äº¤äº’ã€è¿›åº¦å±•ç¤ºã€ç»“æœå‘ˆç°
- åç«¯ï¼šæ™ºèƒ½ä½“åä½œã€MCPé›†æˆã€å¤æ‚æ¨ç†
- APIï¼šæ ‡å‡†åŒ–çš„æ¥å£åè®®

#### **2.2 MCPç”Ÿæ€é›†æˆ**
âœ… **æ ‡å‡†åŒ–ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ**
- ç»Ÿä¸€çš„MCPåè®®ç®€åŒ–å·¥å…·é›†æˆ
- æ”¯æŒçƒ­æ’æ‹”å¼å·¥å…·æ›¿æ¢
- å›½å†…å¤–æœåŠ¡å•†çš„æ™ºèƒ½é€‚é…

#### **2.3 å®æ—¶è¿›åº¦è¿½è¸ª**
âœ… **å…¨æµç¨‹å¯è§‚æµ‹æ€§**
```javascript
// 7ä¸ªå…³é”®é˜¶æ®µçš„è¿›åº¦è¿½è¸ª
è¿›åº¦é˜¶æ®µæ˜ å°„ï¼š
0-15%: ç³»ç»Ÿåˆå§‹åŒ–ï¼ŒåŠ è½½MCPå·¥å…·
15-30%: Coordinatoråˆ†ææ—…æ¸¸éœ€æ±‚  
30-50%: Plannerç”Ÿæˆè¯¦ç»†è§„åˆ’
50-70%: Factoryåˆ›å»ºä¸“ä¸šæ™ºèƒ½ä½“
70-85%: AgentProxyæ‰§è¡Œæ—…æ¸¸ä»»åŠ¡
85-95%: Reporteræ•´åˆç»“æœ
95-100%: å®Œæˆè¾“å‡ºå’Œæ ¼å¼åŒ–
```

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŠ¿

#### **3.1 ä¸€ç«™å¼æœåŠ¡ä½“éªŒ**
âœ… **ä»éœ€æ±‚åˆ°ç»“æœçš„å®Œæ•´é—­ç¯**
- è¡¨å•åŒ–éœ€æ±‚æ”¶é›† â†’ ç»“æ„åŒ–éœ€æ±‚æè¿°
- å®æ—¶è¿›åº¦å±•ç¤º â†’ ç”¨æˆ·ç­‰å¾…ä½“éªŒä¼˜åŒ–
- å¤šæ ¼å¼ç»“æœå±•ç¤º â†’ Markdownå¯¼å‡ºæ”¯æŒ

#### **3.2 æ™ºèƒ½åŒ–ç¨‹åº¦é«˜**
âœ… **å¤šå±‚æ¬¡æ™ºèƒ½å†³ç­–**
- åœ°ç†ä½ç½®è‡ªåŠ¨è¯†åˆ« â†’ MCPå·¥å…·æ™ºèƒ½é€‰æ‹©
- é¢„ç®—çº¦æŸè‡ªåŠ¨åˆ†æ â†’ æ–¹æ¡ˆæ™ºèƒ½ä¼˜åŒ–
- å®æ—¶æ¡ä»¶æ„ŸçŸ¥ â†’ åŠ¨æ€æ–¹æ¡ˆè°ƒæ•´

---

## ğŸš€ æŠ€æœ¯å‘å±•å»ºè®®

### 1. çŸ­æœŸä¼˜åŒ–æ–¹å‘

#### **1.1 å‰ç«¯ä½“éªŒå¢å¼º**
```javascript
// å»ºè®®å¢åŠ çš„åŠŸèƒ½
- å®æ—¶åœ°å›¾é›†æˆï¼šå¯è§†åŒ–å±•ç¤ºæ—…æ¸¸è·¯çº¿
- ä»·æ ¼è¶‹åŠ¿åˆ†æï¼šæ˜¾ç¤ºæœºç¥¨é…’åº—ä»·æ ¼å˜åŒ–
- å¤©æ°”é¢„æŠ¥é›†æˆï¼šå®æ—¶å¤©æ°”ä¿¡æ¯å±•ç¤º
- å¤šæ–¹æ¡ˆå¯¹æ¯”ï¼šæä¾›ä¸åŒé¢„ç®—çš„é€‰æ‹©æ–¹æ¡ˆ
```

#### **1.2 åç«¯èƒ½åŠ›æ‰©å±•**
```python
# å»ºè®®å¢å¼ºçš„èƒ½åŠ›
- ç”¨æˆ·åå¥½å­¦ä¹ ï¼šåŸºäºå†å²æ•°æ®ä¸ªæ€§åŒ–æ¨è
- å®æ—¶ä»·æ ¼è·å–ï¼šå¯¹æ¥çœŸå®é¢„è®¢ç³»ç»Ÿ
- å¤šè¯­è¨€æ”¯æŒï¼šå›½é™…åŒ–æ—…æ¸¸æœåŠ¡
- ç¾¤ä½“åè°ƒï¼šå¤šäººæ—…è¡Œçš„åå¥½å¹³è¡¡
```

### 2. é•¿æœŸæ¶æ„æ¼”è¿›

#### **2.1 å¾®æœåŠ¡åŒ–æ”¹é€ **
```yaml
# å»ºè®®çš„æœåŠ¡æ‹†åˆ†
services:
  - travel-coordinator: æ—…æ¸¸è¯·æ±‚åˆ†ææœåŠ¡
  - travel-planner: æ™ºèƒ½è§„åˆ’æœåŠ¡  
  - mcp-orchestrator: MCPå·¥å…·ç¼–æ’æœåŠ¡
  - travel-executor: æ—…æ¸¸ä»»åŠ¡æ‰§è¡ŒæœåŠ¡
  - result-generator: ç»“æœç”ŸæˆæœåŠ¡
```

#### **2.2 æ•°æ®é©±åŠ¨ä¼˜åŒ–**
```python
# å»ºè®®å¢åŠ çš„æ•°æ®èƒ½åŠ›
- ç”¨æˆ·è¡Œä¸ºåˆ†æï¼šä¼˜åŒ–æ¨èç®—æ³•
- æˆæœ¬æ•ˆç›Šè¿½è¸ªï¼šæå‡é¢„ç®—ä¼˜åŒ–ç²¾åº¦
- æˆåŠŸç‡ç›‘æ§ï¼šæŒç»­æ”¹è¿›è§„åˆ’è´¨é‡
- A/Bæµ‹è¯•æ¡†æ¶ï¼šéªŒè¯æ–°åŠŸèƒ½æ•ˆæœ
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒå‘ç°

1. **å®Œå…¨éµå¾ªæ ‡å‡†å·¥ä½œæµ**ï¼šå½“å‰æ—…æ¸¸æ™ºèƒ½ä½“äº§å“å®Œå…¨åŸºäº Coordinator â†’ Planner â†’ Publisher â†’ AgentProxy â†’ Factory â†’ Reporter æ ‡å‡†å·¥ä½œæµå®ç°ï¼Œæ²¡æœ‰ç ´åæ€§ä¿®æ”¹ã€‚

2. **é¢†åŸŸä¸“ä¸šåŒ–å®šåˆ¶**ï¼šé€šè¿‡å†…å®¹æ³¨å…¥ã€é…ç½®å¢å¼ºã€æç¤ºè¯å·¥ç¨‹ç­‰æ–¹å¼å®ç°æ—…æ¸¸é¢†åŸŸçš„ä¸“ä¸šåŒ–ï¼Œä¿æŒäº†æ¶æ„çš„é€šç”¨æ€§ã€‚

3. **MCPé›†æˆé€æ˜åŒ–**ï¼šMCPå·¥å…·çš„é€‰æ‹©å’Œè°ƒç”¨å¯¹å‰ç«¯å®Œå…¨é€æ˜ï¼Œé€šè¿‡åç«¯æ™ºèƒ½ç¼–æ’å®ç°å›½å†…å¤–å·¥å…·çš„è‡ªåŠ¨é€‚é…ã€‚

4. **å‰åç«¯èŒè´£æ¸…æ™°**ï¼šå‰ç«¯ä¸“æ³¨ç”¨æˆ·ä½“éªŒï¼Œåç«¯ä¸“æ³¨æ™ºèƒ½å†³ç­–ï¼Œé€šè¿‡æ ‡å‡†APIå®ç°è§£è€¦ã€‚

### æŠ€æœ¯ä»·å€¼

- âœ… **å¯ç»´æŠ¤æ€§**ï¼šæ ‡å‡†å·¥ä½œæµæ¶æ„ç¡®ä¿ä»£ç çš„å¯ç»´æŠ¤æ€§
- âœ… **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡æ”¯æŒæ–°åŠŸèƒ½çš„å¿«é€Ÿé›†æˆ  
- âœ… **å¯å¤ç”¨æ€§**ï¼šæ—…æ¸¸å®šåˆ¶æ–¹æ¡ˆå¯æ¨å¹¿åˆ°å…¶ä»–å‚ç›´é¢†åŸŸ
- âœ… **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„è¿›åº¦è¿½è¸ªå’Œæ—¥å¿—è®°å½•

### å•†ä¸šä»·å€¼

- ğŸ¯ **äº§å“åŒ–ç¨‹åº¦é«˜**ï¼šä»åŸå‹åˆ°å¯éƒ¨ç½²äº§å“çš„å®Œæ•´å®ç°
- ğŸ¯ **ç”¨æˆ·ä½“éªŒä¼˜ç§€**ï¼šç›´è§‚çš„ç•Œé¢å’Œå®æ—¶çš„åé¦ˆæœºåˆ¶
- ğŸ¯ **æŠ€æœ¯å…ˆè¿›æ€§**ï¼šåŸºäºæœ€æ–°çš„MCPç”Ÿæ€å’Œå¤šæ™ºèƒ½ä½“æŠ€æœ¯
- ğŸ¯ **å¸‚åœºé€‚ç”¨æ€§**ï¼šåŒæ—¶æ”¯æŒå›½å†…å¤–æ—…æ¸¸å¸‚åœºçš„å·®å¼‚åŒ–éœ€æ±‚

å½“å‰æ—…æ¸¸æ™ºèƒ½ä½“åŸå‹äº§å“åœ¨æŠ€æœ¯æ¶æ„ã€ç”¨æˆ·ä½“éªŒå’Œå•†ä¸šåŒ–å¯è¡Œæ€§æ–¹é¢éƒ½è¾¾åˆ°äº†è¾ƒé«˜æ°´å‡†ï¼Œä¸ºåç»­çš„äº§å“åŒ–æ¨å¹¿å’ŒæŠ€æœ¯æ¼”è¿›å¥ å®šäº†åšå®åŸºç¡€ã€‚ 

---

## ğŸš¨ **é‡è¦å‘ç°ï¼šå½“å‰å®ç°çŠ¶æ€ä¸æ–‡æ¡£å·®å¼‚åˆ†æ**

### ç°çŠ¶æ¾„æ¸…

ç»è¿‡æ·±å…¥ä»£ç åˆ†æï¼Œå‘ç°å½“å‰æ–‡æ¡£ä¸­æè¿°çš„è®¸å¤šæ—…æ¸¸é¢†åŸŸå®šåˆ¶åŒ–åŠŸèƒ½**å¹¶æœªåœ¨ä»£ç ä¸­å®é™…å®ç°**ã€‚å½“å‰ç³»ç»Ÿçš„çœŸå®å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

#### **å½“å‰çœŸå®çš„å·¥ä½œæµç¨‹**
```javascript
// å‰ç«¯å®é™…è°ƒç”¨
fetch('/api/generate', {
    method: 'POST',
    body: JSON.stringify({
        content: travelRequest,  // ç»“æ„åŒ–æ—…æ¸¸éœ€æ±‚æ–‡æœ¬
        user_id: 'travel_user_' + Date.now()
    })
})
â†“
// åç«¯å®é™…æ‰§è¡Œæµç¨‹
GeneratorServer._run_code_generation()
â†’ EnhancedCooragentProjectGenerator.generate_project()
â†’ run_agent_workflow()  // æ ‡å‡†å·¥ä½œæµï¼Œæ— æ—…æ¸¸å®šåˆ¶
â†’ ç”Ÿæˆé€šç”¨Cooragenté¡¹ç›®ä»£ç 
â†’ è¿”å›ZIPæ–‡ä»¶ä¸‹è½½
```

#### **å…³é”®å·®å¼‚å¯¹æ¯”**

| æ–‡æ¡£æè¿°ï¼ˆç†æƒ³ï¼‰ | å½“å‰å®ç°ï¼ˆç°å®ï¼‰ | çŠ¶æ€ |
|---|---|---|
| TravelCoordinator (æ—…æ¸¸åè°ƒå™¨) | æ ‡å‡† Coordinator | âŒ æœªå®ç° |
| TravelPlanner (æ—…æ¸¸è§„åˆ’å™¨) | æ ‡å‡† Planner | âŒ æœªå®ç° |
| TravelPublisher (æ—…æ¸¸å‘å¸ƒå™¨) | æ ‡å‡† Publisher | âŒ æœªå®ç° |
| æ™ºèƒ½MCPå·¥å…·é€‰æ‹© | å›ºå®šMCPé…ç½® | âŒ æœªå®ç° |
| åœ°ç†æ„ŸçŸ¥è·¯ç”± | æ— åœ°ç†è¯†åˆ« | âŒ æœªå®ç° |
| æ—…æ¸¸ä¸“ä¸šåŒ–æ™ºèƒ½ä½“åˆ›å»º | é€šç”¨æ™ºèƒ½ä½“åˆ›å»º | âŒ æœªå®ç° |
| å®æ—¶æ—…æ¸¸è§„åˆ’æ‰§è¡Œ | ä»£ç ç”Ÿæˆé¡¹ç›®è¿”å› | âŒ åŠŸèƒ½ä¸ç¬¦ |

#### **å½“å‰ç³»ç»Ÿå®é™…åŠŸèƒ½**
1. **å‰ç«¯**: æä¾›æ—…æ¸¸è¡¨å•ç•Œé¢
2. **åç«¯**: æ¥æ”¶æ—…æ¸¸éœ€æ±‚æ–‡æœ¬
3. **å·¥ä½œæµ**: æ‰§è¡Œæ ‡å‡† Coordinator â†’ Planner â†’ Publisher â†’ AgentProxy â†’ Factory â†’ Reporter
4. **è¾“å‡º**: ç”Ÿæˆä¸€ä¸ªåŒ…å«æ—…æ¸¸éœ€æ±‚åˆ†æçš„é€šç”¨Cooragenté¡¹ç›®ä»£ç 
5. **ç»“æœ**: ç”¨æˆ·ä¸‹è½½ZIPæ–‡ä»¶ï¼Œéœ€è¦è‡ªå·±éƒ¨ç½²å’Œè¿è¡Œ

---

## ğŸ“‹ **æ—…æ¸¸æ™ºèƒ½ä½“äº§å“å¼€å‘è®¡åˆ’**

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„æ”¹é€  (2-3å‘¨)

#### **1.1 åˆ›å»ºæ—…æ¸¸ä¸“ç”¨å·¥ä½œæµç»„ä»¶**

##### **ä»»åŠ¡ 1.1.1: åˆ›å»º TravelCoordinator**
**æ–‡ä»¶ä½ç½®**: `src/workflow/travel_coordinator.py`
```python
# éœ€è¦åˆ›å»ºçš„æ ¸å¿ƒä»£ç 
class TravelCoordinator:
    """æ—…æ¸¸ä¸“ç”¨åè°ƒå™¨ï¼Œå¢å¼ºåœ°ç†æ„ŸçŸ¥å’Œä»»åŠ¡åˆ†ç±»èƒ½åŠ›"""
    
    def __init__(self):
        self.geo_detector = GeographyDetector()
        self.travel_classifier = TravelTaskClassifier()
    
    async def coordinate_travel_request(self, state: State) -> Command:
        """æ—…æ¸¸è¯·æ±‚åè°ƒé€»è¾‘"""
        
        # 1. åœ°ç†ä½ç½®è¯†åˆ«
        departure, destination = self.geo_detector.extract_locations(state["messages"])
        travel_region = self.geo_detector.classify_region(destination)
        
        # 2. ä»»åŠ¡å¤æ‚åº¦åˆ†æ
        complexity = self.travel_classifier.analyze_complexity(state["messages"])
        
        # 3. æ™ºèƒ½è·¯ç”±å†³ç­–
        if complexity == "simple":
            return Command(goto="direct_response")
        else:
            return Command(
                update={"travel_context": {
                    "departure": departure,
                    "destination": destination, 
                    "region": travel_region,
                    "mcp_config": self._select_mcp_tools(travel_region)
                }},
                goto="travel_planner"
            )
```

**æµ‹è¯•æ–¹æ¡ˆ**:
```python
# tests/test_travel_coordinator.py
class TestTravelCoordinator:
    def test_geography_detection(self):
        """æµ‹è¯•åœ°ç†ä½ç½®è¯†åˆ«å‡†ç¡®æ€§"""
        coordinator = TravelCoordinator()
        
        # æµ‹è¯•ä¸­å›½å›½å†…
        result = coordinator.geo_detector.extract_locations("åŒ—äº¬åˆ°æˆéƒ½çš„æ—…æ¸¸")
        assert result == ("åŒ—äº¬", "æˆéƒ½")
        assert coordinator.geo_detector.classify_region("æˆéƒ½") == "china"
        
        # æµ‹è¯•å›½é™…æ—…æ¸¸
        result = coordinator.geo_detector.extract_locations("ä¸Šæµ·åˆ°å·´é»çš„æ—…æ¸¸")
        assert result == ("ä¸Šæµ·", "å·´é»")
        assert coordinator.geo_detector.classify_region("å·´é»") == "international"
    
    def test_task_complexity_analysis(self):
        """æµ‹è¯•ä»»åŠ¡å¤æ‚åº¦åˆ†æ"""
        coordinator = TravelCoordinator()
        
        # ç®€å•æŸ¥è¯¢
        simple_query = "åŒ—äº¬æœ‰ä»€ä¹ˆå¥½ç©çš„ï¼Ÿ"
        assert coordinator.travel_classifier.analyze_complexity(simple_query) == "simple"
        
        # å¤æ‚è§„åˆ’
        complex_query = "å¸®æˆ‘åˆ¶å®šåŒ—äº¬3å¤©æ·±åº¦æ¸¸è®¡åˆ’ï¼Œé¢„ç®—5000å…ƒ"
        assert coordinator.travel_classifier.analyze_complexity(complex_query) == "complex"
```

##### **ä»»åŠ¡ 1.1.2: åˆ›å»º TravelPlanner**
**æ–‡ä»¶ä½ç½®**: `src/workflow/travel_planner.py`
```python
class TravelPlanner:
    """æ—…æ¸¸ä¸“ç”¨è§„åˆ’å™¨ï¼Œå¢å¼ºåœ°ç†ç©ºé—´å’Œé¢„ç®—ä¼˜åŒ–èƒ½åŠ›"""
    
    def __init__(self):
        self.route_optimizer = RouteOptimizer()
        self.budget_analyzer = BudgetAnalyzer()
        self.weather_integrator = WeatherIntegrator()
    
    async def plan_travel_itinerary(self, state: State) -> Command:
        """ç”Ÿæˆä¼˜åŒ–çš„æ—…æ¸¸è§„åˆ’"""
        
        travel_context = state.get("travel_context", {})
        user_requirements = self._parse_user_requirements(state["messages"])
        
        # 1. åœ°ç†ç©ºé—´ä¼˜åŒ–
        optimized_route = await self.route_optimizer.optimize_route(
            departure=travel_context["departure"],
            destination=travel_context["destination"],
            duration=user_requirements["duration"],
            preferences=user_requirements["preferences"]
        )
        
        # 2. é¢„ç®—æ™ºèƒ½åˆ†é…
        budget_plan = await self.budget_analyzer.allocate_budget(
            total_budget=user_requirements["budget"],
            route=optimized_route,
            travelers=user_requirements["travelers"]
        )
        
        # 3. å¤©æ°”é€‚åº”æ€§è§„åˆ’
        weather_optimized_plan = await self.weather_integrator.adapt_for_weather(
            optimized_route, user_requirements["travel_dates"]
        )
        
        return Command(
            update={
                "travel_plan": {
                    "route": weather_optimized_plan,
                    "budget": budget_plan,
                    "required_agents": self._determine_required_agents(weather_optimized_plan),
                    "required_tools": self._determine_required_tools(travel_context["region"])
                }
            },
            goto="travel_publisher"
        )
```

**æµ‹è¯•æ–¹æ¡ˆ**:
```python
# tests/test_travel_planner.py
class TestTravelPlanner:
    def test_route_optimization(self):
        """æµ‹è¯•è·¯çº¿ä¼˜åŒ–ç®—æ³•"""
        planner = TravelPlanner()
        
        # æµ‹è¯•å¤šæ™¯ç‚¹è·¯çº¿ä¼˜åŒ–
        route = await planner.route_optimizer.optimize_route(
            departure="åŒ—äº¬",
            destination="æˆéƒ½",
            duration=3,
            preferences=["æ–‡åŒ–å†å²", "ç¾é£Ÿä½“éªŒ"]
        )
        
        # éªŒè¯è·¯çº¿åˆç†æ€§
        assert len(route["daily_plans"]) == 3
        assert "å¤©åºœå¹¿åœº" in str(route)  # åº”åŒ…å«æˆéƒ½åœ°æ ‡
        assert route["total_distance"] < 1000  # è·ç¦»åˆç†
    
    def test_budget_allocation(self):
        """æµ‹è¯•é¢„ç®—åˆ†é…ç®—æ³•"""
        planner = TravelPlanner()
        
        budget_plan = await planner.budget_analyzer.allocate_budget(
            total_budget=5000,
            route=mock_route,
            travelers=2
        )
        
        # éªŒè¯é¢„ç®—åˆ†é…åˆç†æ€§
        assert budget_plan["transportation"] + budget_plan["accommodation"] + \
               budget_plan["food"] + budget_plan["activities"] <= 5000
        assert budget_plan["transportation"] > 0  # æ‰€æœ‰ç±»åˆ«éƒ½æœ‰åˆ†é…
```

##### **ä»»åŠ¡ 1.1.3: åˆ›å»º TravelPublisher**
**æ–‡ä»¶ä½ç½®**: `src/workflow/travel_publisher.py`
```python
class TravelPublisher:
    """æ—…æ¸¸ä¸“ç”¨å‘å¸ƒå™¨ï¼Œæ™ºèƒ½ä»»åŠ¡åˆ†å‘å’Œåœ°ç†èšç±»ä¼˜åŒ–"""
    
    def __init__(self):
        self.task_clusterer = GeographicTaskClusterer()
        self.timing_validator = TimingValidator()
    
    async def publish_travel_tasks(self, state: State) -> Command:
        """æ™ºèƒ½åˆ†å‘æ—…æ¸¸ä»»åŠ¡"""
        
        travel_plan = state["travel_plan"]
        
        # 1. åœ°ç†èšç±»ä¼˜åŒ–
        clustered_tasks = self.task_clusterer.cluster_by_location(
            travel_plan["route"]["daily_plans"]
        )
        
        # 2. æ—¶é—´çª—å£éªŒè¯
        validated_tasks = await self.timing_validator.validate_timing(
            clustered_tasks
        )
        
        # 3. æ™ºèƒ½ä»»åŠ¡åˆ†å‘
        task_assignments = self._assign_tasks_to_agents(
            validated_tasks,
            travel_plan["required_agents"]
        )
        
        return Command(
            update={
                "task_assignments": task_assignments,
                "execution_order": self._determine_execution_order(task_assignments)
            },
            goto="travel_agent_proxy"
        )
```

#### **1.2 é›†æˆæ™ºèƒ½MCPå·¥å…·é€‰æ‹©**

##### **ä»»åŠ¡ 1.2.1: åˆ›å»ºæ™ºèƒ½å·¥å…·ç¼–æ’å™¨**
**æ–‡ä»¶ä½ç½®**: `src/mcp/travel_tool_orchestrator.py`
```python
class IntelligentTravelToolOrchestrator:
    """æ™ºèƒ½æ—…æ¸¸å·¥å…·ç¼–æ’å™¨ï¼Œå®ç°åŠ¨æ€MCPå·¥å…·é€‰æ‹©"""
    
    def __init__(self):
        self.tool_configs = {
            "china": {
                "amap": {"url": "https://mcp.amap.com/sse"},
                "ctrip": {"command": "python", "args": ["tools/ctrip_server.py"]},
                "dianping": {"command": "node", "args": ["tools/dianping_server.js"]}
            },
            "international": {
                "google_maps": {"url": "https://mcp.google.com/maps"},
                "booking": {"url": "https://mcp.booking.com/sse"},
                "yelp": {"command": "python", "args": ["tools/yelp_server.py"]}
            }
        }
    
    async def get_mcp_client_for_destination(self, destination: str, region: str):
        """æ ¹æ®ç›®çš„åœ°åŠ¨æ€é€‰æ‹©MCPå®¢æˆ·ç«¯"""
        
        if region == "china":
            config = self.tool_configs["china"]
            logger.info(f"ğŸ‡¨ğŸ‡³ Loading China travel MCP configuration for {destination}")
        else:
            config = self.tool_configs["international"]
            logger.info(f"ğŸŒ Loading International travel MCP configuration for {destination}")
        
        # åŠ¨æ€å¯åŠ¨MCPæœåŠ¡å™¨
        mcp_client = MultiServerMCPClient(config)
        await mcp_client.connect()
        
        return mcp_client
    
    def _is_china_destination(self, destination: str) -> bool:
        """åˆ¤æ–­ç›®çš„åœ°æ˜¯å¦ä¸ºä¸­å›½å¢ƒå†…"""
        china_cities = ["åŒ—äº¬", "ä¸Šæµ·", "å¹¿å·", "æ·±åœ³", "æˆéƒ½", "æ­å·", "è¥¿å®‰", "å—äº¬"]  # å¯æ‰©å±•
        return any(city in destination for city in china_cities)
```

**æµ‹è¯•æ–¹æ¡ˆ**:
```python
# tests/test_travel_tool_orchestrator.py
class TestTravelToolOrchestrator:
    def test_mcp_client_selection(self):
        """æµ‹è¯•MCPå®¢æˆ·ç«¯é€‰æ‹©é€»è¾‘"""
        orchestrator = IntelligentTravelToolOrchestrator()
        
        # æµ‹è¯•ä¸­å›½ç›®çš„åœ°
        assert orchestrator._is_china_destination("åŒ—äº¬") == True
        assert orchestrator._is_china_destination("å·´é»") == False
        
    async def test_mcp_client_creation(self):
        """æµ‹è¯•MCPå®¢æˆ·ç«¯åˆ›å»º"""
        orchestrator = IntelligentTravelToolOrchestrator()
        
        # æ¨¡æ‹Ÿåˆ›å»ºä¸­å›½æ—…æ¸¸MCPå®¢æˆ·ç«¯
        client = await orchestrator.get_mcp_client_for_destination("åŒ—äº¬", "china")
        assert client is not None
        
        # éªŒè¯å·¥å…·å¯ç”¨æ€§
        tools = await client.get_tools()
        tool_names = [tool.name for tool in tools]
        assert "amap_search" in tool_names  # åº”åŒ…å«é«˜å¾·åœ°å›¾å·¥å…·
```

### é˜¶æ®µäºŒï¼šæ ¸å¿ƒåŠŸèƒ½å®ç° (3-4å‘¨)

#### **2.1 é‡æ„å·¥ä½œæµå…¥å£**

##### **ä»»åŠ¡ 2.1.1: ä¿®æ”¹ä¸»å·¥ä½œæµæ–‡ä»¶**
**æ–‡ä»¶ä½ç½®**: `src/workflow/process.py`
```python
# åœ¨ç°æœ‰ run_agent_workflow å‡½æ•°ä¸­æ·»åŠ æ—…æ¸¸æ£€æµ‹é€»è¾‘

async def run_agent_workflow(...):
    """å¢å¼ºçš„å·¥ä½œæµå…¥å£ï¼Œæ”¯æŒæ—…æ¸¸ä¸“ç”¨è·¯ç”±"""
    
    # æ£€æµ‹æ˜¯å¦ä¸ºæ—…æ¸¸ç›¸å…³ä»»åŠ¡
    if is_travel_related_task(user_input_messages):
        logger.info("æ£€æµ‹åˆ°æ—…æ¸¸ä»»åŠ¡ï¼Œå¯åŠ¨æ—…æ¸¸ä¸“ç”¨å·¥ä½œæµ")
        
        # ä½¿ç”¨æ—…æ¸¸ä¸“ç”¨å·¥ä½œæµå›¾
        travel_workflow = create_travel_workflow_graph()
        async for event in travel_workflow.astream(...):
            yield event
    else:
        # ä½¿ç”¨æ ‡å‡†å·¥ä½œæµ
        async for event in workflow.astream(...):
            yield event

def is_travel_related_task(messages: List[Dict]) -> bool:
    """æ£€æµ‹æ˜¯å¦ä¸ºæ—…æ¸¸ç›¸å…³ä»»åŠ¡"""
    travel_keywords = ["æ—…æ¸¸", "æ—…è¡Œ", "å‡ºè¡Œ", "åº¦å‡", "è¡Œç¨‹", "æ™¯ç‚¹", "æœºç¥¨", "é…’åº—"]
    content = " ".join([msg["content"] for msg in messages])
    return any(keyword in content for keyword in travel_keywords)

def create_travel_workflow_graph():
    """åˆ›å»ºæ—…æ¸¸ä¸“ç”¨å·¥ä½œæµå›¾"""
    from src.workflow.travel_coordinator import TravelCoordinator
    from src.workflow.travel_planner import TravelPlanner
    from src.workflow.travel_publisher import TravelPublisher
    
    # æ„å»ºæ—…æ¸¸ä¸“ç”¨å·¥ä½œæµ
    workflow = StateGraph(State)
    
    # æ·»åŠ æ—…æ¸¸ä¸“ç”¨èŠ‚ç‚¹
    workflow.add_node("travel_coordinator", TravelCoordinator().coordinate_travel_request)
    workflow.add_node("travel_planner", TravelPlanner().plan_travel_itinerary)
    workflow.add_node("travel_publisher", TravelPublisher().publish_travel_tasks)
    
    # ä¿ç•™æ ‡å‡†èŠ‚ç‚¹
    workflow.add_node("agent_proxy", agent_proxy_node)
    workflow.add_node("agent_factory", agent_factory_node)
    workflow.add_node("reporter", reporter_node)
    
    # å®šä¹‰æ—…æ¸¸ä¸“ç”¨æµç¨‹
    workflow.set_entry_point("travel_coordinator")
    workflow.add_edge("travel_coordinator", "travel_planner")
    workflow.add_edge("travel_planner", "travel_publisher")
    workflow.add_edge("travel_publisher", "agent_proxy")
    # ... å…¶ä»–è¾¹å®šä¹‰
    
    return workflow.compile()
```

##### **ä»»åŠ¡ 2.1.2: ä¿®æ”¹APIæ¥å£ï¼Œæ”¯æŒæ—…æ¸¸ç›´æ¥æ‰§è¡Œ**
**æ–‡ä»¶ä½ç½®**: `src/api/generator_api.py`
```python
# æ·»åŠ æ—…æ¸¸ä¸“ç”¨APIç«¯ç‚¹

@self.app.post("/api/travel/plan", response_model=TravelPlanResponse)
async def generate_travel_plan(request: TravelPlanRequest, background_tasks: BackgroundTasks):
    """ç›´æ¥ç”Ÿæˆæ—…æ¸¸è§„åˆ’ï¼ˆä¸ç”Ÿæˆä»£ç é¡¹ç›®ï¼‰"""
    task_id = str(uuid.uuid4())
    
    # æ„å»ºæ—…æ¸¸ä¸“ç”¨è¯·æ±‚
    travel_input = self._build_travel_input(request)
    
    # ç›´æ¥æ‰§è¡Œæ—…æ¸¸å·¥ä½œæµï¼Œè¿”å›è§„åˆ’ç»“æœ
    background_tasks.add_task(self._execute_travel_workflow, task_id, travel_input)
    
    return TravelPlanResponse(
        task_id=task_id,
        status="processing",
        message="æ­£åœ¨ç”Ÿæˆæ—…æ¸¸è§„åˆ’..."
    )

async def _execute_travel_workflow(self, task_id: str, travel_input: str):
    """æ‰§è¡Œæ—…æ¸¸å·¥ä½œæµå¹¶è¿”å›è§„åˆ’ç»“æœ"""
    
    try:
        # ç›´æ¥è°ƒç”¨æ—…æ¸¸å·¥ä½œæµ
        messages = [{"role": "user", "content": travel_input}]
        final_result = None
        
        async for event_data in run_agent_workflow(
            user_id=f"travel_{task_id}",
            task_type=TaskType.TRAVEL_PLANNING,  # æ–°å¢ä»»åŠ¡ç±»å‹
            user_input_messages=messages,
            debug=False
        ):
            # æ›´æ–°æ—…æ¸¸è§„åˆ’è¿›åº¦
            await self._update_travel_progress(task_id, event_data)
            final_result = event_data
        
        # è§£ææœ€ç»ˆçš„æ—…æ¸¸è§„åˆ’ç»“æœ
        travel_plan = self._parse_travel_result(final_result)
        
        # æ›´æ–°ä»»åŠ¡çŠ¶æ€
        self.travel_tasks[task_id].status = "completed"
        self.travel_tasks[task_id].travel_plan = travel_plan
        
    except Exception as e:
        self.travel_tasks[task_id].status = "failed"
        self.travel_tasks[task_id].error = str(e)

def _build_travel_input(self, request: TravelPlanRequest) -> str:
    """æ„å»ºç»“æ„åŒ–çš„æ—…æ¸¸è¾“å…¥"""
    return f"""è¯·å¸®æˆ‘åˆ¶å®šä»{request.departure}åˆ°{request.destination}çš„æ—…æ¸¸è®¡åˆ’ã€‚
å‡ºè¡Œæ—¶é—´ï¼š{request.start_date} è‡³ {request.end_date}
å‡ºè¡Œäººæ•°ï¼š{request.travelers}
é¢„ç®—èŒƒå›´ï¼š{request.budget}
æ—…è¡Œåå¥½ï¼š{request.preference}
{request.special_requests if request.special_requests else ''}

è¯·æä¾›è¯¦ç»†çš„æ—…æ¸¸è§„åˆ’ï¼ŒåŒ…æ‹¬ï¼š
1. å¾€è¿”èˆªç­æ¨èå’Œä»·æ ¼
2. ä½å®¿æ¨èï¼ˆåŒ…å«ä»·æ ¼å’Œä½ç½®ï¼‰
3. æ¯æ—¥è¡Œç¨‹å®‰æ’å’Œæ™¯ç‚¹æ¨è
4. ç¾é£Ÿæ¨è
5. è¯¦ç»†é¢„ç®—åˆ†æ
6. æ—…è¡Œè´´å£«å’Œæ³¨æ„äº‹é¡¹"""
```

**æµ‹è¯•æ–¹æ¡ˆ**:
```python
# tests/test_travel_api.py
class TestTravelAPI:
    async def test_travel_plan_generation(self):
        """æµ‹è¯•æ—…æ¸¸è§„åˆ’ç”ŸæˆAPI"""
        
        # æ„å»ºæµ‹è¯•è¯·æ±‚
        request_data = {
            "departure": "åŒ—äº¬",
            "destination": "æˆéƒ½", 
            "start_date": "2024-08-15",
            "end_date": "2024-08-18",
            "travelers": 2,
            "budget": "èˆ’é€‚å‹ï¼ˆ5000-10000ï¼‰",
            "preference": "ç¾é£Ÿä½“éªŒ"
        }
        
        # è°ƒç”¨API
        response = await client.post("/api/travel/plan", json=request_data)
        assert response.status_code == 200
        
        task_id = response.json()["task_id"]
        
        # ç­‰å¾…è§„åˆ’å®Œæˆ
        await asyncio.sleep(30)  # ç­‰å¾…å·¥ä½œæµæ‰§è¡Œ
        
        # è·å–ç»“æœ
        result_response = await client.get(f"/api/travel/plan/{task_id}/result")
        assert result_response.status_code == 200
        
        travel_plan = result_response.json()["travel_plan"]
        
        # éªŒè¯è§„åˆ’å†…å®¹
        assert "è¡Œç¨‹æ¦‚è§ˆ" in travel_plan
        assert "äº¤é€šå®‰æ’" in travel_plan
        assert "ä½å®¿æ¨è" in travel_plan
        assert "æˆéƒ½" in travel_plan  # åº”åŒ…å«ç›®çš„åœ°ä¿¡æ¯
        
    def test_geography_detection_integration(self):
        """æµ‹è¯•åœ°ç†ä½ç½®æ£€æµ‹é›†æˆ"""
        
        # æµ‹è¯•å›½å†…æ—…æ¸¸
        domestic_request = {
            "departure": "ä¸Šæµ·",
            "destination": "æ­å·"
        }
        # åº”è¯¥é€‰æ‹©ä¸­å›½MCPå·¥å…·
        
        # æµ‹è¯•å›½é™…æ—…æ¸¸  
        international_request = {
            "departure": "åŒ—äº¬", 
            "destination": "ä¸œäº¬"
        }
        # åº”è¯¥é€‰æ‹©å›½é™…MCPå·¥å…·
```

### é˜¶æ®µä¸‰ï¼šå‰ç«¯åŠŸèƒ½å‡çº§ (1-2å‘¨)

#### **3.1 ä¿®æ”¹å‰ç«¯ç›´æ¥è°ƒç”¨æ—…æ¸¸API**

##### **ä»»åŠ¡ 3.1.1: æ›´æ–°å‰ç«¯JavaScript**
**æ–‡ä»¶ä½ç½®**: `travel_planner_frontend.html`
```javascript
// ä¿®æ”¹ç”Ÿæˆæ—…è¡Œè®¡åˆ’å‡½æ•°ï¼Œç›´æ¥è°ƒç”¨æ—…æ¸¸APIè€Œä¸æ˜¯ä»£ç ç”ŸæˆAPI

async function generateTravelPlan(requestData) {
    try {
        // è°ƒç”¨ä¸“ç”¨æ—…æ¸¸è§„åˆ’API
        const response = await fetch(`${API_BASE_URL}/api/travel/plan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                departure: requestData.departure,
                destination: requestData.destination,
                start_date: requestData.startDate,
                end_date: requestData.endDate,
                travelers: requestData.travelers,
                budget: requestData.budget,
                preference: requestData.preference,
                special_requests: requestData.specialRequests
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: æ—…æ¸¸è§„åˆ’è¯·æ±‚å¤±è´¥`);
        }

        const data = await response.json();
        currentTaskId = data.task_id;
        
        // è½®è¯¢æ—…æ¸¸è§„åˆ’çŠ¶æ€
        pollTravelPlanStatus(currentTaskId);
        
    } catch (error) {
        console.error('æ—…æ¸¸è§„åˆ’ç”Ÿæˆå¤±è´¥:', error);
        throw error;
    }
}

async function pollTravelPlanStatus(taskId) {
    const pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/api/travel/plan/${taskId}/status`);
            const data = await response.json();
            
            updateProgress(data.progress || 0, data.stage || 'å¤„ç†ä¸­...');
            
            if (data.status === 'completed') {
                clearInterval(pollInterval);
                
                // è·å–æ—…æ¸¸è§„åˆ’ç»“æœ
                const resultResponse = await fetch(`${API_BASE_URL}/api/travel/plan/${taskId}/result`);
                const resultData = await resultResponse.json();
                
                updateProgress(100, 'ç”Ÿæˆå®Œæˆï¼');
                showResult(resultData.travel_plan);
                hideProgress();
                
            } else if (data.status === 'failed') {
                clearInterval(pollInterval);
                throw new Error(data.error || 'æ—…æ¸¸è§„åˆ’ç”Ÿæˆå¤±è´¥');
            }
        } catch (error) {
            clearInterval(pollInterval);
            console.error('è½®è¯¢çŠ¶æ€å¤±è´¥:', error);
            hideProgress();
            alert('è·å–çŠ¶æ€å¤±è´¥: ' + error.message);
        }
    }, 2000);
}

// æ·»åŠ å®æ—¶è¿›åº¦é˜¶æ®µæ˜ å°„
const travelProgressStages = {
    "travel_coordinator": "åˆ†ææ—…æ¸¸éœ€æ±‚å’Œåœ°ç†ä½ç½®...",
    "travel_planner": "ç”Ÿæˆæ™ºèƒ½è¡Œç¨‹è§„åˆ’...",
    "travel_publisher": "ä¼˜åŒ–ä»»åŠ¡åˆ†å‘...",
    "agent_proxy": "æ‰§è¡Œä¸“ä¸šæ—…æ¸¸æ™ºèƒ½ä½“...",
    "reporter": "æ•´åˆæœ€ç»ˆæ—…æ¸¸æ–¹æ¡ˆ..."
};
```

### é˜¶æ®µå››ï¼šæµ‹è¯•ä¸éƒ¨ç½² (2å‘¨)

#### **4.1 é›†æˆæµ‹è¯•æ–¹æ¡ˆ**

##### **ç«¯åˆ°ç«¯æµ‹è¯•**
```python
# tests/test_travel_e2e.py
class TestTravelE2E:
    """ç«¯åˆ°ç«¯æ—…æ¸¸åŠŸèƒ½æµ‹è¯•"""
    
    async def test_complete_travel_planning_flow(self):
        """æµ‹è¯•å®Œæ•´çš„æ—…æ¸¸è§„åˆ’æµç¨‹"""
        
        # 1. æµ‹è¯•å‰ç«¯è¡¨å•æäº¤
        travel_request = {
            "departure": "åŒ—äº¬",
            "destination": "æˆéƒ½",
            "start_date": "2024-08-15", 
            "end_date": "2024-08-18",
            "travelers": 2,
            "budget": "èˆ’é€‚å‹ï¼ˆ5000-10000ï¼‰",
            "preference": "ç¾é£Ÿä½“éªŒ",
            "special_requests": "æ¨èå·èœè€å­—å·"
        }
        
        # 2. æäº¤æ—…æ¸¸è§„åˆ’è¯·æ±‚
        response = await self.submit_travel_request(travel_request)
        task_id = response["task_id"]
        
        # 3. éªŒè¯å·¥ä½œæµæ‰§è¡Œ
        events = await self.monitor_workflow_execution(task_id)
        
        # éªŒè¯æ—…æ¸¸ä¸“ç”¨ç»„ä»¶è¢«è°ƒç”¨
        assert any("travel_coordinator" in str(event) for event in events)
        assert any("travel_planner" in str(event) for event in events)
        
        # 4. éªŒè¯MCPå·¥å…·é€‰æ‹©
        # ç”±äºç›®çš„åœ°æ˜¯æˆéƒ½ï¼ˆä¸­å›½ï¼‰ï¼Œåº”è¯¥é€‰æ‹©ä¸­å›½MCPå·¥å…·
        assert any("amap" in str(event) for event in events)
        assert any("dianping" in str(event) for event in events)
        
        # 5. éªŒè¯æœ€ç»ˆç»“æœ
        final_result = await self.get_travel_plan_result(task_id)
        
        # éªŒè¯ç»“æœåŒ…å«é¢„æœŸå†…å®¹
        assert "æˆéƒ½" in final_result["travel_plan"]
        assert "å·èœ" in final_result["travel_plan"]
        assert "é¢„ç®—åˆ†æ" in final_result["travel_plan"]
        assert "è¡Œç¨‹å®‰æ’" in final_result["travel_plan"]
        
    async def test_international_travel_mcp_selection(self):
        """æµ‹è¯•å›½é™…æ—…æ¸¸MCPå·¥å…·é€‰æ‹©"""
        
        travel_request = {
            "departure": "åŒ—äº¬",
            "destination": "å·´é»",  # å›½é™…ç›®çš„åœ°
            "start_date": "2024-08-15",
            "end_date": "2024-08-20"
        }
        
        response = await self.submit_travel_request(travel_request)
        events = await self.monitor_workflow_execution(response["task_id"])
        
        # éªŒè¯é€‰æ‹©äº†å›½é™…MCPå·¥å…·
        assert any("google_maps" in str(event) for event in events)
        assert any("booking" in str(event) for event in events)
        assert not any("amap" in str(event) for event in events)  # ä¸åº”è¯¥æœ‰é«˜å¾·åœ°å›¾
```

##### **æ€§èƒ½æµ‹è¯•**
```python
# tests/test_travel_performance.py
class TestTravelPerformance:
    """æ—…æ¸¸åŠŸèƒ½æ€§èƒ½æµ‹è¯•"""
    
    async def test_travel_planning_response_time(self):
        """æµ‹è¯•æ—…æ¸¸è§„åˆ’å“åº”æ—¶é—´"""
        
        start_time = time.time()
        
        # æäº¤æ ‡å‡†æ—…æ¸¸è¯·æ±‚
        response = await self.submit_standard_travel_request()
        task_id = response["task_id"]
        
        # ç­‰å¾…å®Œæˆ
        await self.wait_for_completion(task_id)
        
        end_time = time.time()
        execution_time = end_time - start_time
        
        # éªŒè¯åœ¨åˆç†æ—¶é—´å†…å®Œæˆï¼ˆä¾‹å¦‚3åˆ†é’Ÿï¼‰
        assert execution_time < 180, f"æ—…æ¸¸è§„åˆ’è€—æ—¶è¿‡é•¿: {execution_time}ç§’"
        
    async def test_concurrent_travel_requests(self):
        """æµ‹è¯•å¹¶å‘æ—…æ¸¸è¯·æ±‚å¤„ç†èƒ½åŠ›"""
        
        # åŒæ—¶æäº¤10ä¸ªæ—…æ¸¸è§„åˆ’è¯·æ±‚
        tasks = []
        for i in range(10):
            task = asyncio.create_task(self.submit_and_complete_travel_request(f"test_user_{i}"))
            tasks.append(task)
        
        results = await asyncio.gather(*tasks)
        
        # éªŒè¯æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸå®Œæˆ
        assert len(results) == 10
        assert all(result["status"] == "completed" for result in results)
```

#### **4.2 éƒ¨ç½²é…ç½®**

##### **Dockeré…ç½®å¢å¼º**
```dockerfile
# Dockerfile å¢åŠ æ—…æ¸¸ä¸“ç”¨é…ç½®
FROM python:3.11-slim

# å®‰è£…æ—…æ¸¸ç›¸å…³ä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Node.js MCPæœåŠ¡å™¨
RUN npm install -g @modelcontextprotocol/server-filesystem

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . /app
WORKDIR /app

# å®‰è£…Pythonä¾èµ–
RUN pip install -r requirements.txt

# åˆ›å»ºæ—…æ¸¸ä¸“ç”¨ç›®å½•
RUN mkdir -p /app/data/travel_plans
RUN mkdir -p /app/logs/travel

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV TRAVEL_MODE=enabled
ENV MCP_AUTO_SELECTION=true

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["python", "src/api/generator_api.py", "--enable-travel"]
```

##### **docker-compose.yml æ—…æ¸¸æœåŠ¡é…ç½®**
```yaml
version: '3.8'
services:
  travel-agent:
    build: .
    ports:
      - "8000:8000"
    environment:
      - TRAVEL_MODE=enabled
      - AMAP_API_KEY=${AMAP_API_KEY}
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./data/travel_plans:/app/data/travel_plans
      - ./logs:/app/logs
    depends_on:
      - redis
      - postgres

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"

  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: travel_agent
      POSTGRES_USER: travel_user
      POSTGRES_PASSWORD: travel_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### é˜¶æ®µäº”ï¼šç›‘æ§ä¸ä¼˜åŒ– (1å‘¨)

#### **5.1 æ·»åŠ æ—…æ¸¸ä¸“ç”¨ç›‘æ§**

```python
# src/monitoring/travel_monitoring.py
class TravelPerformanceMonitor:
    """æ—…æ¸¸åŠŸèƒ½æ€§èƒ½ç›‘æ§"""
    
    def __init__(self):
        self.metrics = {
            "total_requests": 0,
            "successful_plans": 0,
            "failed_plans": 0,
            "avg_response_time": 0,
            "mcp_tool_usage": {},
            "popular_destinations": {}
        }
    
    def record_travel_request(self, request_data):
        """è®°å½•æ—…æ¸¸è¯·æ±‚"""
        self.metrics["total_requests"] += 1
        
        destination = request_data.get("destination")
        if destination:
            self.metrics["popular_destinations"][destination] = \
                self.metrics["popular_destinations"].get(destination, 0) + 1
    
    def record_planning_result(self, task_id, status, execution_time, tools_used):
        """è®°å½•è§„åˆ’ç»“æœ"""
        if status == "completed":
            self.metrics["successful_plans"] += 1
        else:
            self.metrics["failed_plans"] += 1
        
        # æ›´æ–°å¹³å‡å“åº”æ—¶é—´
        current_avg = self.metrics["avg_response_time"]
        total_completed = self.metrics["successful_plans"]
        self.metrics["avg_response_time"] = \
            ((current_avg * (total_completed - 1)) + execution_time) / total_completed
        
        # è®°å½•å·¥å…·ä½¿ç”¨
        for tool in tools_used:
            self.metrics["mcp_tool_usage"][tool] = \
                self.metrics["mcp_tool_usage"].get(tool, 0) + 1
```

---

## ğŸ¯ **æ€»ç»“ä¸å»ºè®®**

### å½“å‰çŠ¶æ€
- âœ… **å‰ç«¯ç•Œé¢**: å·²å®Œæˆï¼Œæä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ
- âœ… **åŸºç¡€æ¶æ„**: Cooragentæ¡†æ¶å®Œæ•´ï¼Œæ”¯æŒæ‰©å±•
- âŒ **æ—…æ¸¸å®šåˆ¶**: å¤§éƒ¨åˆ†åŠŸèƒ½ä»…å­˜åœ¨äºæ–‡æ¡£è®¾è®¡ä¸­
- âŒ **å®é™…åŠŸèƒ½**: å½“å‰åªèƒ½ç”Ÿæˆä»£ç é¡¹ç›®ï¼Œæ— æ³•ç›´æ¥æ‰§è¡Œæ—…æ¸¸è§„åˆ’

### å¼€å‘ä¼˜å…ˆçº§
1. **é«˜ä¼˜å…ˆçº§**: é˜¶æ®µä¸€ï¼ˆåŸºç¡€æ¶æ„æ”¹é€ ï¼‰- åˆ›å»ºæ—…æ¸¸ä¸“ç”¨å·¥ä½œæµç»„ä»¶
2. **ä¸­ä¼˜å…ˆçº§**: é˜¶æ®µäºŒï¼ˆæ ¸å¿ƒåŠŸèƒ½å®ç°ï¼‰- å®ç°çœŸæ­£çš„æ—…æ¸¸è§„åˆ’åŠŸèƒ½
3. **ä½ä¼˜å…ˆçº§**: é˜¶æ®µä¸‰-äº”ï¼ˆå‰ç«¯å‡çº§ã€æµ‹è¯•ã€éƒ¨ç½²ä¼˜åŒ–ï¼‰

### å®æ–½å»ºè®®
1. **å…ˆåšMVP**: ä¸“æ³¨å®ç°æœ€æ ¸å¿ƒçš„æ—…æ¸¸è§„åˆ’åŠŸèƒ½ï¼Œæš‚ç¼“å¤æ‚çš„åœ°ç†ä¼˜åŒ–
2. **æ¸è¿›å¼å¼€å‘**: å…ˆå®ç°åŸºæœ¬çš„TravelCoordinatorï¼Œå†é€æ­¥æ·»åŠ é«˜çº§åŠŸèƒ½
3. **å……åˆ†æµ‹è¯•**: æ¯ä¸ªé˜¶æ®µå®Œæˆåè¿›è¡Œå……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. **ç”¨æˆ·åé¦ˆ**: å°½æ—©éƒ¨ç½²MVPç‰ˆæœ¬ï¼Œæ”¶é›†ç”¨æˆ·åé¦ˆæŒ‡å¯¼åç»­å¼€å‘

### é¢„æœŸæ•ˆæœ
å®Œæˆä¸Šè¿°å¼€å‘è®¡åˆ’åï¼Œæ—…æ¸¸æ™ºèƒ½ä½“å°†çœŸæ­£å…·å¤‡ï¼š
- ğŸ¯ å®æ—¶æ—…æ¸¸è§„åˆ’æ‰§è¡Œï¼ˆè€Œéä»£ç ç”Ÿæˆï¼‰
- ğŸ—ºï¸ æ™ºèƒ½åœ°ç†ä½ç½®è¯†åˆ«å’ŒMCPå·¥å…·é€‰æ‹©
- ğŸ¤– æ—…æ¸¸ä¸“ä¸šåŒ–æ™ºèƒ½ä½“åä½œ
- ğŸ“Š å®Œæ•´çš„ç›‘æ§å’Œæ€§èƒ½ä¼˜åŒ–
- ğŸš€ äº§å“åŒ–çš„éƒ¨ç½²å’Œè¿ç»´èƒ½åŠ› 