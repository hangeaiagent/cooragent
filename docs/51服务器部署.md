# 服务器部署文档

## 📋 部署概述

本文档记录了CoorAgent旅游智能体系统在生产服务器(44.203.197.203)上的完整部署过程，包括环境配置、域名设置、SSL证书和自动化运维。

## 🖥️ 服务器信息

- **服务器地址**: 44.203.197.203
- **SSH密钥**: /Users/a1/work/productmindai.pem
- **操作系统**: Amazon Linux 2023
- **用户**: ec2-user
- **域名**: gitagent.io

## 🚀 部署步骤

### 1. 代码部署

```bash
# 连接服务器
ssh -i /Users/a1/work/productmindai.pem ec2-user@44.203.197.203

# 下载项目代码
sudo rm -rf /home/gitagent
sudo git clone https://github.com/hangeaiagent/cooragent.git /home/gitagent
sudo chown -R ec2-user:ec2-user /home/gitagent
```

### 2. 配置文件部署

```bash
# 从本地拷贝配置文件
scp -i /Users/a1/work/productmindai.pem .env ec2-user@44.203.197.203:/home/gitagent/
scp -i /Users/a1/work/productmindai.pem config/mcp.json ec2-user@44.203.197.203:/home/gitagent/config/
```

### 3. 环境依赖安装

```bash
# 检查Python版本 (需要3.12+)
python3 --version  # Python 3.12.8

# 安装项目依赖
cd /home/gitagent
pip3 install -e .
```

### 4. Nginx安装与配置

```bash
# 安装nginx
sudo dnf install -y nginx

# 启用并启动nginx
sudo systemctl enable nginx
sudo systemctl start nginx

# 创建站点配置目录
sudo mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled

# 创建gitagent.io配置文件
sudo tee /etc/nginx/sites-available/gitagent.io << 'EOF'
server {
    listen 80;
    server_name gitagent.io www.gitagent.io;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name gitagent.io www.gitagent.io;

    # SSL证书配置
    ssl_certificate /etc/letsencrypt/live/gitagent.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gitagent.io/privkey.pem;

    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 网站根目录
    root /home/gitagent;
    index index.html travel_planner_frontend.html;

    # 后台API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_timeout 300s;
        proxy_read_timeout 300s;
    }

    # 健康检查代理
    location /health {
        proxy_pass http://127.0.0.1:8000/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API文档代理
    location /docs {
        proxy_pass http://127.0.0.1:8000/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件服务
    location / {
        try_files $uri $uri/ =404;
        
        # 安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    }

    # 日志配置
    access_log /var/log/nginx/gitagent.io_access.log;
    error_log /var/log/nginx/gitagent.io_error.log;
}
EOF

# 启用站点配置
sudo ln -sf /etc/nginx/sites-available/gitagent.io /etc/nginx/sites-enabled/

# 测试配置并重新加载
sudo nginx -t
sudo systemctl reload nginx
```

### 5. SSL证书配置

```bash
# 安装certbot
sudo dnf install -y python3-certbot-nginx

# 申请SSL证书
sudo certbot --nginx -d gitagent.io --non-interactive --agree-tos --email admin@gitagent.io

# 设置自动续期
echo '0 12 * * * /usr/bin/certbot renew --quiet && /usr/bin/systemctl reload nginx' | sudo crontab -
```

### 6. 应用后台运行配置

```bash
# 方式一：使用screen (当前使用)
cd /home/gitagent
export PYTHONPATH=/home/gitagent/src:/home/gitagent
export PYTHONUNBUFFERED=1
screen -dmS cooragent python3 generator_cli.py server --host 0.0.0.0 --port 8000

# 方式二：systemd服务文件 (备用方案)
sudo tee /etc/systemd/system/cooragent.service << 'EOF'
[Unit]
Description=CoorAgent Travel Planning System
After=network.target
Wants=network.target

[Service]
Type=simple
User=ec2-user
Group=ec2-user
WorkingDirectory=/home/gitagent
Environment=PATH=/home/ec2-user/.local/bin:/usr/local/bin:/usr/bin:/bin
Environment=PYTHONPATH=/home/gitagent/src:/home/gitagent
Environment=PYTHONUNBUFFERED=1
ExecStart=/usr/bin/python3.11 /home/gitagent/generator_cli.py server --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable cooragent
sudo systemctl start cooragent
```

## 🔧 启动命令和管理

### 应用启动

```bash
# 启动应用 (screen方式)
cd /home/gitagent
export PYTHONPATH=/home/gitagent/src:/home/gitagent
export PYTHONUNBUFFERED=1
screen -dmS cooragent python3 generator_cli.py server --host 0.0.0.0 --port 8000

# 查看screen会话
screen -list

# 连接到应用会话
screen -r cooragent

# 分离会话 (在screen内按Ctrl+A然后按D)
```

### 服务管理

```bash
# 检查应用进程
ps aux | grep generator_cli

# 检查应用健康状态
curl http://localhost:8000/health

# 检查nginx状态
sudo systemctl status nginx

# 重新加载nginx配置
sudo nginx -t && sudo systemctl reload nginx

# 查看应用日志 (如果使用systemd)
sudo journalctl -u cooragent -f

# 查看nginx日志
sudo tail -f /var/log/nginx/gitagent.io_access.log
sudo tail -f /var/log/nginx/gitagent.io_error.log
```

### 应用重启

```bash
# 方式一：重启screen会话
pkill -f "generator_cli.py"
cd /home/gitagent
export PYTHONPATH=/home/gitagent/src:/home/gitagent
export PYTHONUNBUFFERED=1
screen -dmS cooragent python3 generator_cli.py server --host 0.0.0.0 --port 8000

# 方式二：systemd重启 (如果使用systemd)
sudo systemctl restart cooragent
```

## 🌐 访问地址

- **主站**: https://gitagent.io
- **API文档**: https://gitagent.io/docs  
- **健康检查**: https://gitagent.io/health

## 📊 监控和维护

### 系统监控

```bash
# 检查系统资源
htop
df -h
free -h

# 检查端口占用
sudo lsof -i :80
sudo lsof -i :443
sudo lsof -i :8000

# 检查SSL证书过期时间
sudo certbot certificates
```

### 定期维护

```bash
# 更新系统包
sudo dnf update -y

# 更新项目代码
cd /home/gitagent
git pull origin main
pip3 install -e . --upgrade

# 清理日志文件
sudo find /var/log/nginx/ -name "*.log" -type f -mtime +30 -delete
```

## 🔒 安全配置

### 防火墙设置

```bash
# 检查防火墙状态
sudo firewall-cmd --state

# 开放必要端口
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --reload
```

### SSL证书自动续期

```bash
# 查看当前crontab
sudo crontab -l

# 手动测试证书续期
sudo certbot renew --dry-run

# 强制续期
sudo certbot renew --force-renewal
```

## 🐛 故障排除

### 常见问题

1. **应用无法启动**
   ```bash
   # 检查Python环境
   python3 --version
   which python3
   
   # 检查依赖包
   pip3 list | grep fastapi
   
   # 检查工作目录和权限
   ls -la /home/gitagent
   ```

2. **Nginx配置错误**
   ```bash
   # 测试nginx配置
   sudo nginx -t
   
   # 查看nginx错误日志
   sudo tail -f /var/log/nginx/error.log
   ```

3. **SSL证书问题**
   ```bash
   # 检查证书状态
   sudo certbot certificates
   
   # 重新申请证书
   sudo certbot --nginx -d gitagent.io --force-renewal
   ```

4. **应用连接问题**
   ```bash
   # 测试后台API
   curl http://localhost:8000/health
   
   # 检查端口监听
   sudo netstat -tlnp | grep :8000
   ```

## 📝 部署总结

✅ **完成项目:**

1. ✅ 代码部署: GitHub仓库成功下载到 `/home/gitagent`
2. ✅ 配置文件: `.env` 和 `config/mcp.json` 已部署
3. ✅ 环境安装: Python 3.12.8 + 项目依赖安装完成
4. ✅ Nginx配置: 反向代理和静态文件服务配置完成
5. ✅ 域名配置: gitagent.io 域名解析和nginx配置完成
6. ✅ SSL证书: Let's Encrypt 证书申请和配置完成
7. ✅ 自动续期: SSL证书自动续期任务设置完成
8. ✅ 后台运行: Screen会话确保应用持续运行
9. ✅ 服务测试: 健康检查API正常响应

**🎯 关键成果:**
- 应用成功部署并运行在 https://gitagent.io
- 后台API服务运行在端口8000，通过nginx代理访问
- SSL证书有效，支持HTTPS访问
- 自动化运维：证书自动续期、应用后台运行
- 完整的启动、管理和故障排除文档

**🔧 核心命令总结:**
```bash
# 启动应用
cd /home/gitagent && export PYTHONPATH=/home/gitagent/src:/home/gitagent && screen -dmS cooragent python3 generator_cli.py server --host 0.0.0.0 --port 8000

# 检查状态
curl http://localhost:8000/health
ps aux | grep generator_cli

# 重启nginx
sudo nginx -t && sudo systemctl reload nginx
```

---

**📧 技术支持**: 如有问题请检查日志文件或联系开发团队
**📅 部署日期**: 2025-08-08
**🔄 更新日期**: 2025-08-08