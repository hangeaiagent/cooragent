# æœåŠ¡å™¨éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ éƒ¨ç½²æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†CoorAgentæ—…æ¸¸æ™ºèƒ½ä½“ç³»ç»Ÿåœ¨ç”Ÿäº§æœåŠ¡å™¨(44.203.197.203)ä¸Šçš„å®Œæ•´éƒ¨ç½²è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ç¯å¢ƒé…ç½®ã€åŸŸåè®¾ç½®ã€SSLè¯ä¹¦å’Œè‡ªåŠ¨åŒ–è¿ç»´ã€‚

## ğŸ–¥ï¸ æœåŠ¡å™¨ä¿¡æ¯

- **æœåŠ¡å™¨åœ°å€**: 44.203.197.203
- **SSHå¯†é’¥**: /Users/a1/work/productmindai.pem
- **æ“ä½œç³»ç»Ÿ**: Amazon Linux 2023
- **ç”¨æˆ·**: ec2-user
- **åŸŸå**: gitagent.io

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ä»£ç éƒ¨ç½²

```bash
# è¿æ¥æœåŠ¡å™¨
ssh -i /Users/a1/work/productmindai.pem ec2-user@44.203.197.203

# ä¸‹è½½é¡¹ç›®ä»£ç 
sudo rm -rf /home/gitagent
sudo git clone https://github.com/hangeaiagent/cooragent.git /home/gitagent
sudo chown -R ec2-user:ec2-user /home/gitagent
```

### 2. é…ç½®æ–‡ä»¶éƒ¨ç½²

```bash
# ä»æœ¬åœ°æ‹·è´é…ç½®æ–‡ä»¶
scp -i /Users/a1/work/productmindai.pem .env ec2-user@44.203.197.203:/home/gitagent/
scp -i /Users/a1/work/productmindai.pem config/mcp.json ec2-user@44.203.197.203:/home/gitagent/config/
```

### 3. ç¯å¢ƒä¾èµ–å®‰è£…

```bash
# æ£€æŸ¥Pythonç‰ˆæœ¬ (éœ€è¦3.12+)
python3 --version  # Python 3.12.8

# å®‰è£…é¡¹ç›®ä¾èµ–
cd /home/gitagent
pip3 install -e .
```

### 4. Nginxå®‰è£…ä¸é…ç½®

```bash
# å®‰è£…nginx
sudo dnf install -y nginx

# å¯ç”¨å¹¶å¯åŠ¨nginx
sudo systemctl enable nginx
sudo systemctl start nginx

# åˆ›å»ºç«™ç‚¹é…ç½®ç›®å½•
sudo mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled

# åˆ›å»ºgitagent.ioé…ç½®æ–‡ä»¶
sudo tee /etc/nginx/sites-available/gitagent.io << 'EOF'
server {
    listen 80;
    server_name gitagent.io www.gitagent.io;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name gitagent.io www.gitagent.io;

    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/gitagent.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gitagent.io/privkey.pem;

    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # ç½‘ç«™æ ¹ç›®å½•
    root /home/gitagent;
    index index.html travel_planner_frontend.html;

    # åå°APIä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_timeout 300s;
        proxy_read_timeout 300s;
    }

    # å¥åº·æ£€æŸ¥ä»£ç†
    location /health {
        proxy_pass http://127.0.0.1:8000/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # APIæ–‡æ¡£ä»£ç†
    location /docs {
        proxy_pass http://127.0.0.1:8000/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # é™æ€æ–‡ä»¶æœåŠ¡
    location / {
        try_files $uri $uri/ =404;
        
        # å®‰å…¨å¤´
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    }

    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/gitagent.io_access.log;
    error_log /var/log/nginx/gitagent.io_error.log;
}
EOF

# å¯ç”¨ç«™ç‚¹é…ç½®
sudo ln -sf /etc/nginx/sites-available/gitagent.io /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®å¹¶é‡æ–°åŠ è½½
sudo nginx -t
sudo systemctl reload nginx
```

### 5. SSLè¯ä¹¦é…ç½®

```bash
# å®‰è£…certbot
sudo dnf install -y python3-certbot-nginx

# ç”³è¯·SSLè¯ä¹¦
sudo certbot --nginx -d gitagent.io --non-interactive --agree-tos --email admin@gitagent.io

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ
echo '0 12 * * * /usr/bin/certbot renew --quiet && /usr/bin/systemctl reload nginx' | sudo crontab -
```

### 6. åº”ç”¨åå°è¿è¡Œé…ç½®

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨screen (å½“å‰ä½¿ç”¨)
cd /home/gitagent
export PYTHONPATH=/home/gitagent/src:/home/gitagent
export PYTHONUNBUFFERED=1
screen -dmS cooragent python3 generator_cli.py server --host 0.0.0.0 --port 8000

# æ–¹å¼äºŒï¼šsystemdæœåŠ¡æ–‡ä»¶ (å¤‡ç”¨æ–¹æ¡ˆ)
sudo tee /etc/systemd/system/cooragent.service << 'EOF'
[Unit]
Description=CoorAgent Travel Planning System
After=network.target
Wants=network.target

[Service]
Type=simple
User=ec2-user
Group=ec2-user
WorkingDirectory=/home/gitagent
Environment=PATH=/home/ec2-user/.local/bin:/usr/local/bin:/usr/bin:/bin
Environment=PYTHONPATH=/home/gitagent/src:/home/gitagent
Environment=PYTHONUNBUFFERED=1
ExecStart=/usr/bin/python3.11 /home/gitagent/generator_cli.py server --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable cooragent
sudo systemctl start cooragent
```

## ğŸ”§ å¯åŠ¨å‘½ä»¤å’Œç®¡ç†

### åº”ç”¨å¯åŠ¨

```bash
# å¯åŠ¨åº”ç”¨ (screenæ–¹å¼)
cd /home/gitagent
export PYTHONPATH=/home/gitagent/src:/home/gitagent
export PYTHONUNBUFFERED=1
screen -dmS cooragent python3 generator_cli.py server --host 0.0.0.0 --port 8000

# æŸ¥çœ‹screenä¼šè¯
screen -list

# è¿æ¥åˆ°åº”ç”¨ä¼šè¯
screen -r cooragent

# åˆ†ç¦»ä¼šè¯ (åœ¨screenå†…æŒ‰Ctrl+Aç„¶åæŒ‰D)
```

### æœåŠ¡ç®¡ç†

```bash
# æ£€æŸ¥åº”ç”¨è¿›ç¨‹
ps aux | grep generator_cli

# æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
curl http://localhost:8000/health

# æ£€æŸ¥nginxçŠ¶æ€
sudo systemctl status nginx

# é‡æ–°åŠ è½½nginxé…ç½®
sudo nginx -t && sudo systemctl reload nginx

# æŸ¥çœ‹åº”ç”¨æ—¥å¿— (å¦‚æœä½¿ç”¨systemd)
sudo journalctl -u cooragent -f

# æŸ¥çœ‹nginxæ—¥å¿—
sudo tail -f /var/log/nginx/gitagent.io_access.log
sudo tail -f /var/log/nginx/gitagent.io_error.log
```

### åº”ç”¨é‡å¯

```bash
# æ–¹å¼ä¸€ï¼šé‡å¯screenä¼šè¯
pkill -f "generator_cli.py"
cd /home/gitagent
export PYTHONPATH=/home/gitagent/src:/home/gitagent
export PYTHONUNBUFFERED=1
screen -dmS cooragent python3 generator_cli.py server --host 0.0.0.0 --port 8000

# æ–¹å¼äºŒï¼šsystemdé‡å¯ (å¦‚æœä½¿ç”¨systemd)
sudo systemctl restart cooragent
```

## ğŸŒ è®¿é—®åœ°å€

- **ä¸»ç«™**: https://gitagent.io
- **APIæ–‡æ¡£**: https://gitagent.io/docs  
- **å¥åº·æ£€æŸ¥**: https://gitagent.io/health

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### ç³»ç»Ÿç›‘æ§

```bash
# æ£€æŸ¥ç³»ç»Ÿèµ„æº
htop
df -h
free -h

# æ£€æŸ¥ç«¯å£å ç”¨
sudo lsof -i :80
sudo lsof -i :443
sudo lsof -i :8000

# æ£€æŸ¥SSLè¯ä¹¦è¿‡æœŸæ—¶é—´
sudo certbot certificates
```

### å®šæœŸç»´æŠ¤

```bash
# æ›´æ–°ç³»ç»ŸåŒ…
sudo dnf update -y

# æ›´æ–°é¡¹ç›®ä»£ç 
cd /home/gitagent
git pull origin main
pip3 install -e . --upgrade

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
sudo find /var/log/nginx/ -name "*.log" -type f -mtime +30 -delete
```

## ğŸ”’ å®‰å…¨é…ç½®

### é˜²ç«å¢™è®¾ç½®

```bash
# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
sudo firewall-cmd --state

# å¼€æ”¾å¿…è¦ç«¯å£
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --reload
```

### SSLè¯ä¹¦è‡ªåŠ¨ç»­æœŸ

```bash
# æŸ¥çœ‹å½“å‰crontab
sudo crontab -l

# æ‰‹åŠ¨æµ‹è¯•è¯ä¹¦ç»­æœŸ
sudo certbot renew --dry-run

# å¼ºåˆ¶ç»­æœŸ
sudo certbot renew --force-renewal
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **åº”ç”¨æ— æ³•å¯åŠ¨**
   ```bash
   # æ£€æŸ¥Pythonç¯å¢ƒ
   python3 --version
   which python3
   
   # æ£€æŸ¥ä¾èµ–åŒ…
   pip3 list | grep fastapi
   
   # æ£€æŸ¥å·¥ä½œç›®å½•å’Œæƒé™
   ls -la /home/gitagent
   ```

2. **Nginxé…ç½®é”™è¯¯**
   ```bash
   # æµ‹è¯•nginxé…ç½®
   sudo nginx -t
   
   # æŸ¥çœ‹nginxé”™è¯¯æ—¥å¿—
   sudo tail -f /var/log/nginx/error.log
   ```

3. **SSLè¯ä¹¦é—®é¢˜**
   ```bash
   # æ£€æŸ¥è¯ä¹¦çŠ¶æ€
   sudo certbot certificates
   
   # é‡æ–°ç”³è¯·è¯ä¹¦
   sudo certbot --nginx -d gitagent.io --force-renewal
   ```

4. **åº”ç”¨è¿æ¥é—®é¢˜**
   ```bash
   # æµ‹è¯•åå°API
   curl http://localhost:8000/health
   
   # æ£€æŸ¥ç«¯å£ç›‘å¬
   sudo netstat -tlnp | grep :8000
   ```

## ğŸ“ éƒ¨ç½²æ€»ç»“

âœ… **å®Œæˆé¡¹ç›®:**

1. âœ… ä»£ç éƒ¨ç½²: GitHubä»“åº“æˆåŠŸä¸‹è½½åˆ° `/home/gitagent`
2. âœ… é…ç½®æ–‡ä»¶: `.env` å’Œ `config/mcp.json` å·²éƒ¨ç½²
3. âœ… ç¯å¢ƒå®‰è£…: Python 3.12.8 + é¡¹ç›®ä¾èµ–å®‰è£…å®Œæˆ
4. âœ… Nginxé…ç½®: åå‘ä»£ç†å’Œé™æ€æ–‡ä»¶æœåŠ¡é…ç½®å®Œæˆ
5. âœ… åŸŸåé…ç½®: gitagent.io åŸŸåè§£æå’Œnginxé…ç½®å®Œæˆ
6. âœ… SSLè¯ä¹¦: Let's Encrypt è¯ä¹¦ç”³è¯·å’Œé…ç½®å®Œæˆ
7. âœ… è‡ªåŠ¨ç»­æœŸ: SSLè¯ä¹¦è‡ªåŠ¨ç»­æœŸä»»åŠ¡è®¾ç½®å®Œæˆ
8. âœ… åå°è¿è¡Œ: Screenä¼šè¯ç¡®ä¿åº”ç”¨æŒç»­è¿è¡Œ
9. âœ… æœåŠ¡æµ‹è¯•: å¥åº·æ£€æŸ¥APIæ­£å¸¸å“åº”

**ğŸ¯ å…³é”®æˆæœ:**
- åº”ç”¨æˆåŠŸéƒ¨ç½²å¹¶è¿è¡Œåœ¨ https://gitagent.io
- åå°APIæœåŠ¡è¿è¡Œåœ¨ç«¯å£8000ï¼Œé€šè¿‡nginxä»£ç†è®¿é—®
- SSLè¯ä¹¦æœ‰æ•ˆï¼Œæ”¯æŒHTTPSè®¿é—®
- è‡ªåŠ¨åŒ–è¿ç»´ï¼šè¯ä¹¦è‡ªåŠ¨ç»­æœŸã€åº”ç”¨åå°è¿è¡Œ
- å®Œæ•´çš„å¯åŠ¨ã€ç®¡ç†å’Œæ•…éšœæ’é™¤æ–‡æ¡£

**ğŸ”§ æ ¸å¿ƒå‘½ä»¤æ€»ç»“:**
```bash
# å¯åŠ¨åº”ç”¨
cd /home/gitagent && export PYTHONPATH=/home/gitagent/src:/home/gitagent && screen -dmS cooragent python3 generator_cli.py server --host 0.0.0.0 --port 8000

# æ£€æŸ¥çŠ¶æ€
curl http://localhost:8000/health
ps aux | grep generator_cli

# é‡å¯nginx
sudo nginx -t && sudo systemctl reload nginx
```

---

**ğŸ“§ æŠ€æœ¯æ”¯æŒ**: å¦‚æœ‰é—®é¢˜è¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æˆ–è”ç³»å¼€å‘å›¢é˜Ÿ
**ğŸ“… éƒ¨ç½²æ—¥æœŸ**: 2025-08-08
**ğŸ”„ æ›´æ–°æ—¥æœŸ**: 2025-08-08