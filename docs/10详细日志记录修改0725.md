# Cooragentè¯¦ç»†æ—¥å¿—åˆ†æä¸å¤§æ¨¡å‹æ™ºæ…§åº”ç”¨

## 1. æ·»åŠ ä»£ç è¡Œå·çš„è¯¦ç»†æ—¥å¿—å®ç°

### 1.1 å¢å¼ºçš„æ—¥å¿—æ ¼å¼ï¼ˆåŒ…å«è¡Œå·ï¼‰

```python
# src/api/generator_api.py

# ä¸ºæ—¥å¿—æ·»åŠ è¡Œå·è¿½è¸ªçš„è¾…åŠ©å‡½æ•°
def log_with_line(logger_func, message, line_offset=0):
    """ä¸ºæ—¥å¿—æ¶ˆæ¯æ·»åŠ è¡Œå·ä¿¡æ¯"""
    import inspect
    frame = inspect.currentframe().f_back
    line_no = frame.f_lineno + line_offset
    return logger_func(f"{message} | src_line:{line_no}")

@self.app.post("/api/generate", response_model=GenerateResponse)
async def generate_code(request: GenerateRequest, background_tasks: BackgroundTasks):
    """ç”ŸæˆåŸºäºCooragentçš„é¡¹ç›®ä»£ç """
    task_id = str(uuid.uuid4())                                        # line:111
    user_id = request.user_id or f"user_{task_id[:8]}"                 # line:112
    
    # === è¯¦ç»†çš„è¯·æ±‚å‚æ•°æ—¥å¿—è®°å½•ï¼ˆå¸¦è¡Œå·ï¼‰ ===
    gen_logger.info("=" * 80)
    log_with_line(gen_logger.info, "ğŸš€ NEW API REQUEST: /api/generate")                # line:145
    gen_logger.info("=" * 80)
    log_with_line(gen_logger.debug, "REQUEST_PARAMS:")                                 # line:147
    log_with_line(gen_logger.debug, f"  â”œâ”€ task_id: {task_id}")                       # line:148
    log_with_line(gen_logger.debug, f"  â”œâ”€ user_id: {user_id}")                       # line:149
    log_with_line(gen_logger.debug, f"  â”œâ”€ content_length: {len(request.content)}")   # line:150
    log_with_line(gen_logger.debug, f"  â”œâ”€ content_preview: {repr(request.content[:200])}")  # line:151
    log_with_line(gen_logger.debug, f"  â”œâ”€ request_timestamp: {datetime.now().isoformat()}")  # line:152
    log_with_line(gen_logger.debug, f"  â””â”€ full_content: {repr(request.content)}")    # line:153
```

### 1.2 åå°ä»»åŠ¡æ‰§è¡Œçš„è¯¦ç»†æ—¥å¿—ï¼ˆå¸¦è¡Œå·ï¼‰

```python
async def _run_code_generation(self, task_id: str, content: str, user_id: str):
    """è¿è¡Œä»£ç ç”Ÿæˆä»»åŠ¡"""
    # === åå°ä»»åŠ¡å¼€å§‹æ‰§è¡Œè¯¦ç»†æ—¥å¿— ===
    gen_logger.info("=" * 80)
    log_with_line(gen_logger.info, f"ğŸ¯ BACKGROUND TASK STARTED: _run_code_generation")  # line:420
    gen_logger.info("=" * 80)
    log_with_line(gen_logger.debug, f"TASK_EXECUTION_PARAMS:")                           # line:422
    log_with_line(gen_logger.debug, f"  â”œâ”€ task_id: {task_id}")                         # line:423
    log_with_line(gen_logger.debug, f"  â”œâ”€ user_id: {user_id}")                         # line:424
    log_with_line(gen_logger.debug, f"  â”œâ”€ content_length: {len(content)}")             # line:425
    log_with_line(gen_logger.debug, f"  â”œâ”€ content_preview: {repr(content[:150])}")     # line:426
    log_with_line(gen_logger.debug, f"  â””â”€ execution_start: {datetime.now().isoformat()}")  # line:427
    
    task = self.generation_tasks[task_id]                                                # line:429
    log_with_line(gen_logger.debug, f"TASK_STATE_BEFORE_EXECUTION:")                    # line:430
    log_with_line(gen_logger.debug, f"  â”œâ”€ current_status: {task.status}")              # line:431
    log_with_line(gen_logger.debug, f"  â”œâ”€ current_progress: {task.progress}")          # line:432
    log_with_line(gen_logger.debug, f"  â”œâ”€ current_step: {task.current_step}")          # line:433
    log_with_line(gen_logger.debug, f"  â””â”€ task_created_at: {task.created_at}")         # line:434
```

### 1.3 è¿›åº¦æ›´æ–°çš„è¯¦ç»†æ—¥å¿—ï¼ˆå¸¦è¡Œå·ï¼‰

```python
async def update_progress(message: str, progress: int, current_step: str, step_details: str, **kwargs):
    # === è¯¦ç»†è®°å½•æ¯æ¬¡è¿›åº¦æ›´æ–° ===
    log_with_line(gen_logger.debug, f"PROGRESS_UPDATE_CALLED:")                         # line:445
    log_with_line(gen_logger.debug, f"  â”œâ”€ message: {repr(message)}")                  # line:446
    log_with_line(gen_logger.debug, f"  â”œâ”€ progress: {progress}%")                     # line:447
    log_with_line(gen_logger.debug, f"  â”œâ”€ current_step: {repr(current_step)}")        # line:448
    log_with_line(gen_logger.debug, f"  â”œâ”€ step_details: {repr(step_details)}")        # line:449
    log_with_line(gen_logger.debug, f"  â”œâ”€ kwargs: {kwargs}")                          # line:450
    log_with_line(gen_logger.debug, f"  â””â”€ timestamp: {datetime.now().isoformat()}")   # line:451
    
    # æ›´æ–°ä»»åŠ¡çŠ¶æ€
    old_status = {                                                                      # line:453
        'message': task.message,
        'progress': task.progress,
        'current_step': task.current_step,
        'step_details': task.step_details
    }
    
    task.message = message                                                              # line:459
    task.progress = progress                                                            # line:460
    task.current_step = current_step                                                    # line:461
    task.step_details = step_details                                                    # line:462
```

## 2. éœ€æ±‚åˆ†æç»„ä»¶å¦‚ä½•è¿ç”¨å¤§æ¨¡å‹æ™ºæ…§å’Œæç¤ºè¯å·¥ç¨‹

### 2.1 ä¸‰å±‚æ™ºèƒ½åˆ†ææ¶æ„çš„å¤§æ¨¡å‹åº”ç”¨

#### Layer 1: Coordinatorï¼ˆåè°ƒå™¨ï¼‰- ä»»åŠ¡åˆ†ç±»æ™ºèƒ½å†³ç­–

**å¤§æ¨¡å‹æ™ºæ…§åº”ç”¨ï¼š**
```python
# src/workflow/coor_task.py - coordinator_node()
async def coordinator_node(state: State):
    # ğŸ“‹ å¤§æ¨¡å‹åº”ç”¨1: è‡ªç„¶è¯­è¨€ç†è§£å’Œåˆ†ç±»
    messages = apply_prompt_template("coordinator", state)                              # line:25
    response = await get_llm_by_type("coordinator").ainvoke(messages)                   # line:26
    
    log_with_line(gen_logger.debug, f"COORDINATOR_LLM_INPUT:")                         # line:28
    log_with_line(gen_logger.debug, f"  â”œâ”€ prompt_template: coordinator.md")           # line:29
    log_with_line(gen_logger.debug, f"  â”œâ”€ user_query: {state['USER_QUERY']}")         # line:30
    log_with_line(gen_logger.debug, f"  â”œâ”€ llm_type: coordinator")                     # line:31
    log_with_line(gen_logger.debug, f"  â””â”€ context_variables: {list(state.keys())}")   # line:32
    
    content = clean_response_tags(response.content)                                     # line:34
    
    log_with_line(gen_logger.debug, f"COORDINATOR_LLM_OUTPUT:")                        # line:36
    log_with_line(gen_logger.debug, f"  â”œâ”€ raw_response: {repr(response.content[:200])}")  # line:37
    log_with_line(gen_logger.debug, f"  â”œâ”€ cleaned_content: {repr(content[:200])}")     # line:38
    log_with_line(gen_logger.debug, f"  â””â”€ decision_type: {'handover' if 'handover_to_planner' in content else 'direct_reply'}")  # line:39
    
    # ğŸ¯ å…³é”®åˆ¤æ–­é€»è¾‘ï¼šåŸºäºLLMè¾“å‡ºå†³å®šè·¯ç”±
    if "handover_to_planner" in content:                                                # line:42
        goto = "planner"  # è½¬å‘ç»™è§„åˆ’å™¨è¿›è¡Œæ·±åº¦åˆ†æ
        log_with_line(gen_logger.info, f"ğŸ“‹ COORDINATOR_DECISION: handover_to_planner -> complex_task_analysis")  # line:44
    else:
        goto = "__end__"  # ç›´æ¥ç»“æŸï¼Œè¿”å›ç®€å•ç­”æ¡ˆ
        log_with_line(gen_logger.info, f"ğŸ’¬ COORDINATOR_DECISION: direct_reply -> simple_response")  # line:47
    
    return Command(goto=goto, update={"messages": [...]})                               # line:49
```

**æç¤ºè¯å·¥ç¨‹åº”ç”¨ï¼š**
```markdown
<!-- src/prompts/coordinator.md -->
# åè°ƒå™¨æç¤ºè¯æ¨¡æ¿ - æ™ºèƒ½åˆ†ç±»å†³ç­–

ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ä»»åŠ¡åè°ƒå™¨ï¼Œè´Ÿè´£åˆ†æç”¨æˆ·è¾“å…¥å¹¶åšå‡ºè·¯ç”±å†³ç­–ã€‚

## æ ¸å¿ƒä»»åŠ¡
åˆ†æç”¨æˆ·è¯·æ±‚çš„å¤æ‚åº¦ï¼Œå†³å®šå¤„ç†æ–¹å¼ï¼š
- **ç®€å•ä»»åŠ¡**: ç›´æ¥å›å¤ 
- **å¤æ‚ä»»åŠ¡**: è°ƒç”¨ handover_to_planner() ç§»äº¤ç»™è§„åˆ’å™¨

## åˆ†ç±»æ ‡å‡†
### Protocol 1 - ç›´æ¥å›å¤ (ç®€å•ä»»åŠ¡)
é€‚ç”¨åœºæ™¯ï¼š
- é—²èŠå¯¹è¯: "ä½ å¥½", "æ€ä¹ˆæ ·"
- ç®€å•äº‹å®æŸ¥è¯¢: "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½", "æ³•å›½é¦–éƒ½"  
- åŸºç¡€å‘½ä»¤: "ç¿»è¯‘'æ—©ä¸Šå¥½'åˆ°æ—¥è¯­", "50ä¹˜ä»¥4ç­‰äºå¤šå°‘"
- èº«ä»½è¯¢é—®: "ä½ æ˜¯è°", "ä½ æœ‰ä»€ä¹ˆèƒ½åŠ›"

### Protocol 2 - ä»»åŠ¡ç§»äº¤ (å¤æ‚ä»»åŠ¡) 
é€‚ç”¨åœºæ™¯ï¼š
- å¤æ‚åˆ†æä»»åŠ¡: "åˆ†æç‰¹æ–¯æ‹‰è‚¡ç¥¨è¶‹åŠ¿"
- åˆ›æ„ä»»åŠ¡: "å†™ä¸€é¦–å…³äºæµ·æ´‹çš„è¯—" 
- å¤šæ­¥éª¤ä»»åŠ¡: "åˆ›å»ºæ—…è¡Œè®¡åˆ’", "ç¼–å†™Pythonè„šæœ¬", "**åˆ›å»ºæ™ºèƒ½ä½“**"
- ä¸“ä¸šæŒ‡å¯¼: "å¦‚ä½•æ”¹å–„æ—¶é—´ç®¡ç†æŠ€èƒ½"

## å†³ç­–è¾“å‡º
- ç®€å•ä»»åŠ¡: ç›´æ¥æä¾›ç­”æ¡ˆ
- å¤æ‚ä»»åŠ¡: è¾“å‡º "handover_to_planner()" å¹¶è¯´æ˜åŸå› 

## å½“å‰ä¸Šä¸‹æ–‡
- ç”¨æˆ·è¾“å…¥: {USER_QUERY}
- å¯ç”¨æ™ºèƒ½ä½“: {TEAM_MEMBERS}
- å½“å‰æ—¶é—´: {CURRENT_TIME}
```

#### Layer 2: Plannerï¼ˆè§„åˆ’å™¨ï¼‰- æ·±åº¦éœ€æ±‚åˆ†æå’Œæ–¹æ¡ˆç”Ÿæˆ

**å¤§æ¨¡å‹æ™ºæ…§åº”ç”¨ï¼š**
```python
# src/workflow/coor_task.py - planner_node()
async def planner_node(state: State):
    log_with_line(gen_logger.info, f"ğŸ“Š PLANNER_ANALYSIS_START:")                      # line:65
    log_with_line(gen_logger.debug, f"  â”œâ”€ analyzing_user_requirement...")             # line:66
    log_with_line(gen_logger.debug, f"  â”œâ”€ user_query: {state['USER_QUERY']}")         # line:67
    log_with_line(gen_logger.debug, f"  â”œâ”€ workflow_mode: {state['workflow_mode']}")   # line:68
    log_with_line(gen_logger.debug, f"  â””â”€ available_agents: {len(state['TEAM_MEMBERS'])}")  # line:69
    
    # ğŸ“‹ å¤§æ¨¡å‹åº”ç”¨2: æ·±åº¦éœ€æ±‚è§£æå’Œæ™ºèƒ½ä½“åä½œè§„åˆ’
    messages = apply_prompt_template("planner", state)                                  # line:72
    
    # ğŸ¯ ç»“æ„åŒ–è¾“å‡º - ç¡®ä¿LLMè¾“å‡ºç¬¦åˆé¢„æœŸæ ¼å¼
    planning_result = await (
        get_llm_by_type("reasoning")                                                    # line:75
        .with_structured_output(PlanWithAgents)                                        # line:76
        .ainvoke(messages)                                                              # line:77
    )
    
    log_with_line(gen_logger.debug, f"PLANNER_LLM_OUTPUT:")                           # line:80
    log_with_line(gen_logger.debug, f"  â”œâ”€ thought_process: {repr(planning_result.thought[:150])}")  # line:81
    log_with_line(gen_logger.debug, f"  â”œâ”€ task_title: {planning_result.title}")       # line:82
    log_with_line(gen_logger.debug, f"  â”œâ”€ new_agents_needed: {len(planning_result.new_agents_needed)}")  # line:83
    log_with_line(gen_logger.debug, f"  â”œâ”€ execution_steps: {len(planning_result.steps)}")  # line:84
    log_with_line(gen_logger.debug, f"  â””â”€ agents_analysis: {[agent.name for agent in planning_result.new_agents_needed]}")  # line:85
    
    # ğŸ“Š æ™ºèƒ½ä½“éœ€æ±‚åˆ†æ
    for i, agent in enumerate(planning_result.new_agents_needed):                       # line:87
        log_with_line(gen_logger.debug, f"REQUIRED_AGENT_{i+1}:")                      # line:88
        log_with_line(gen_logger.debug, f"  â”œâ”€ name: {agent.name}")                    # line:89
        log_with_line(gen_logger.debug, f"  â”œâ”€ role: {agent.role}")                    # line:90
        log_with_line(gen_logger.debug, f"  â”œâ”€ capabilities: {agent.capabilities}")    # line:91
        log_with_line(gen_logger.debug, f"  â””â”€ contribution: {agent.contribution}")    # line:92
    
    # ğŸ“‹ æ‰§è¡Œæ­¥éª¤åˆ†æ
    for i, step in enumerate(planning_result.steps):                                    # line:94
        log_with_line(gen_logger.debug, f"EXECUTION_STEP_{i+1}:")                      # line:95
        log_with_line(gen_logger.debug, f"  â”œâ”€ agent: {step.agent_name}")              # line:96
        log_with_line(gen_logger.debug, f"  â”œâ”€ title: {step.title}")                   # line:97
        log_with_line(gen_logger.debug, f"  â”œâ”€ description: {step.description}")       # line:98
        log_with_line(gen_logger.debug, f"  â””â”€ note: {getattr(step, 'note', 'N/A')}")  # line:99
```

**æç¤ºè¯å·¥ç¨‹åº”ç”¨ï¼š**
```markdown
<!-- src/prompts/planner.md -->
# è§„åˆ’å™¨æç¤ºè¯æ¨¡æ¿ - æ·±åº¦éœ€æ±‚åˆ†æ

ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¤šæ™ºèƒ½ä½“åä½œè§„åˆ’å¸ˆï¼Œè´Ÿè´£æ·±åº¦åˆ†æç”¨æˆ·éœ€æ±‚å¹¶åˆ¶å®šæ™ºèƒ½ä½“åä½œæ–¹æ¡ˆã€‚

## æ ¸å¿ƒä»»åŠ¡
1. **éœ€æ±‚åˆ†æ**: ç†è§£ç”¨æˆ·çœŸå®æ„å›¾å’Œéšå«éœ€æ±‚
2. **æ™ºèƒ½ä½“è¯„ä¼°**: åˆ†æç°æœ‰æ™ºèƒ½ä½“èƒ½åŠ›æ˜¯å¦æ»¡è¶³éœ€æ±‚  
3. **æ–¹æ¡ˆåˆ¶å®š**: è®¾è®¡æœ€ä¼˜çš„æ™ºèƒ½ä½“åä½œæµç¨‹
4. **èµ„æºè§„åˆ’**: ç¡®å®šæ‰€éœ€å·¥å…·å’Œé…ç½®å‚æ•°

## åˆ†æç»´åº¦

### 1. ä»»åŠ¡å¤æ‚åº¦è¯„ä¼°
- å•æ­¥éª¤ vs å¤šæ­¥éª¤ä»»åŠ¡
- é¢†åŸŸä¸“ä¸šæ€§è¦æ±‚ç¨‹åº¦  
- æ•°æ®å¤„ç†å’Œåˆ†æéœ€æ±‚
- åˆ›æ„å’Œæ¨ç†è¦æ±‚

### 2. ç°æœ‰æ™ºèƒ½ä½“èƒ½åŠ›åŒ¹é…
å½“å‰å¯ç”¨æ™ºèƒ½ä½“å›¢é˜Ÿ:
{TEAM_MEMBERS_DESCRIPTION}

### 3. æ–°æ™ºèƒ½ä½“éœ€æ±‚è¯†åˆ«
å¦‚æœç°æœ‰æ™ºèƒ½ä½“æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œå®šä¹‰æ–°æ™ºèƒ½ä½“ï¼š
- ä¸“ä¸šé¢†åŸŸå’Œæ ¸å¿ƒèƒ½åŠ›
- æ‰€éœ€å·¥å…·å’ŒAPIé›†æˆ
- ä¸å…¶ä»–æ™ºèƒ½ä½“çš„åä½œå…³ç³»

### 4. å·¥å…·éœ€æ±‚åˆ†æ  
å¯ç”¨å·¥å…·é›†åˆ:
{TOOLS}

æ ¹æ®ä»»åŠ¡ç‰¹ç‚¹é€‰æ‹©å¿…è¦å·¥å…·ï¼š
- ä¿¡æ¯æœç´¢: tavily_tool
- ä»£ç æ‰§è¡Œ: python_repl_tool  
- ç³»ç»Ÿæ“ä½œ: bash_tool
- ç½‘é¡µæŠ“å–: crawl_tool
- æµè§ˆå™¨è‡ªåŠ¨åŒ–: browser_tool

## è¾“å‡ºæ ¼å¼ (ç»“æ„åŒ–JSON)
```typescript
interface PlanWithAgents {
  thought: string;              // æ·±åº¦åˆ†ææ€è·¯
  title: string;               // ä»»åŠ¡æ ‡é¢˜  
  new_agents_needed: NewAgent[]; // æ–°æ™ºèƒ½ä½“éœ€æ±‚
  steps: Step[];               // æ‰§è¡Œæ­¥éª¤
}

interface NewAgent {
  name: string;                // æ™ºèƒ½ä½“åç§°
  role: string;               // è§’è‰²å®šä¹‰
  capabilities: string;       // èƒ½åŠ›æè¿°
  contribution: string;       // è´¡çŒ®ä»·å€¼
}

interface Step {
  agent_name: string;         // æ‰§è¡Œæ™ºèƒ½ä½“
  title: string;             // æ­¥éª¤æ ‡é¢˜
  description: string;       // è¯¦ç»†æè¿°  
  note?: string;             // æ³¨æ„äº‹é¡¹
}
```

## å½“å‰åˆ†æåœºæ™¯
- ç”¨æˆ·éœ€æ±‚: {USER_QUERY}
- å·¥ä½œæµæ¨¡å¼: {workflow_mode}
- æ·±åº¦æ€è€ƒ: {deep_thinking_mode}
- æœç´¢å¢å¼º: {search_before_planning}
```

#### Layer 3: Agent Factoryï¼ˆæ™ºèƒ½ä½“å·¥å‚ï¼‰- åŠ¨æ€æ™ºèƒ½ä½“åˆ›å»º

**å¤§æ¨¡å‹æ™ºæ…§åº”ç”¨ï¼š**
```python
# src/workflow/coor_task.py - agent_factory_node() 
async def agent_factory_node(state: State):
    log_with_line(gen_logger.info, f"ğŸ­ AGENT_FACTORY_START:")                         # line:125
    log_with_line(gen_logger.debug, f"  â”œâ”€ creating_specialized_agent...")             # line:126
    log_with_line(gen_logger.debug, f"  â”œâ”€ user_requirement: {state.get('USER_QUERY', '')}")  # line:127
    log_with_line(gen_logger.debug, f"  â””â”€ current_team: {state['TEAM_MEMBERS']}")     # line:128
    
    # ğŸ“‹ å¤§æ¨¡å‹åº”ç”¨3: æ™ºèƒ½ä½“æ¶æ„è®¾è®¡å’Œå·¥å…·é€‰æ‹©
    messages = apply_prompt_template("agent_factory", state)                           # line:131
    
    # ğŸ¯ ç»“æ„åŒ–è¾“å‡º - ç”Ÿæˆå®Œæ•´çš„æ™ºèƒ½ä½“é…ç½®  
    agent_spec = await (
        get_llm_by_type("reasoning")                                                   # line:134
        .with_structured_output(AgentBuilder)                                         # line:135
        .ainvoke(messages)                                                             # line:136
    )
    
    log_with_line(gen_logger.debug, f"AGENT_FACTORY_OUTPUT:")                         # line:139
    log_with_line(gen_logger.debug, f"  â”œâ”€ agent_name: {agent_spec['agent_name']}")   # line:140
    log_with_line(gen_logger.debug, f"  â”œâ”€ agent_description: {agent_spec['agent_description']}")  # line:141
    log_with_line(gen_logger.debug, f"  â”œâ”€ thought_process: {repr(agent_spec['thought'][:150])}")  # line:142
    log_with_line(gen_logger.debug, f"  â”œâ”€ llm_type: {agent_spec['llm_type']}")       # line:143
    log_with_line(gen_logger.debug, f"  â””â”€ tool_count: {len(agent_spec['selected_tools'])}")  # line:144
    
    # ğŸ”§ æ™ºèƒ½å·¥å…·é€‰æ‹©å’ŒéªŒè¯
    tools = []                                                                         # line:147
    log_with_line(gen_logger.debug, f"TOOL_SELECTION_PROCESS:")                       # line:148
    
    for tool in agent_spec["selected_tools"]:                                         # line:150
        tool_name = tool["name"]                                                       # line:151
        if agent_manager.available_tools.get(tool_name):                              # line:152
            tools.append(agent_manager.available_tools[tool_name])                    # line:153
            log_with_line(gen_logger.debug, f"  âœ… tool_added: {tool_name}")          # line:154
            log_with_line(gen_logger.debug, f"     â””â”€ reason: {tool.get('reason', 'N/A')}")  # line:155
        else:
            log_with_line(gen_logger.warning, f"  âŒ tool_unavailable: {tool_name}")  # line:157
            logger.warning("Tool (%s) is not available", tool_name)                   # line:158
    
    # ğŸ¯ æ™ºèƒ½ä½“åˆ›å»ºå’Œæ³¨å†Œ
    log_with_line(gen_logger.info, f"ğŸ”§ CREATING_AGENT:")                            # line:161
    log_with_line(gen_logger.debug, f"  â”œâ”€ calling: agent_manager._create_agent_by_prebuilt")  # line:162
    log_with_line(gen_logger.debug, f"  â”œâ”€ agent_name: {agent_spec['agent_name']}")   # line:163
    log_with_line(gen_logger.debug, f"  â”œâ”€ llm_type: {agent_spec['llm_type']}")       # line:164
    log_with_line(gen_logger.debug, f"  â”œâ”€ tools_count: {len(tools)}")               # line:165
    log_with_line(gen_logger.debug, f"  â””â”€ prompt_length: {len(agent_spec['prompt'])}")  # line:166
    
    await agent_manager._create_agent_by_prebuilt(                                     # line:168
        user_id=state["user_id"],
        name=agent_spec["agent_name"], 
        nick_name=agent_spec["agent_name"],
        llm_type=agent_spec["llm_type"],
        tools=tools,
        prompt=agent_spec["prompt"],
        description=agent_spec["agent_description"],
    )
    
    log_with_line(gen_logger.info, f"âœ… AGENT_CREATED_SUCCESSFULLY:")                 # line:177
    log_with_line(gen_logger.debug, f"  â”œâ”€ registered_as: {agent_spec['agent_name']}") # line:178
    log_with_line(gen_logger.debug, f"  â”œâ”€ capabilities: {agent_spec['agent_description'][:100]}...")  # line:179
    log_with_line(gen_logger.debug, f"  â””â”€ ready_for_execution: True")                # line:180
```

**æç¤ºè¯å·¥ç¨‹åº”ç”¨ï¼š**
```markdown
<!-- src/prompts/agent_factory.md -->
# æ™ºèƒ½ä½“å·¥å‚æç¤ºè¯æ¨¡æ¿ - åŠ¨æ€æ™ºèƒ½ä½“åˆ›å»º

ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ™ºèƒ½ä½“æ¶æ„å¸ˆï¼Œè´Ÿè´£æ ¹æ®ç”¨æˆ·éœ€æ±‚è®¾è®¡å’Œåˆ›å»ºä¸“ä¸šåŒ–æ™ºèƒ½ä½“ã€‚

## æ ¸å¿ƒä»»åŠ¡
1. **éœ€æ±‚ç†è§£**: æ·±åº¦åˆ†æç”¨æˆ·çš„å…·ä½“éœ€æ±‚å’ŒæœŸæœ›
2. **èƒ½åŠ›è®¾è®¡**: å®šä¹‰æ™ºèƒ½ä½“çš„æ ¸å¿ƒèƒ½åŠ›å’Œä¸“ä¸šé¢†åŸŸ
3. **å·¥å…·é€‰æ‹©**: æ™ºèƒ½é€‰æ‹©å¿…è¦çš„å·¥å…·ç»„åˆ
4. **æç¤ºè¯å·¥ç¨‹**: ç¼–å†™é«˜è´¨é‡çš„æ™ºèƒ½ä½“æ‰§è¡Œæç¤ºè¯

## æ™ºèƒ½ä½“è®¾è®¡åŸåˆ™

### 1. ä¸“ä¸šåŒ–åŸåˆ™
- ä¸“æ³¨ç‰¹å®šé¢†åŸŸæˆ–ä»»åŠ¡ç±»å‹
- æ˜ç¡®çš„è§’è‰²å®šä½å’Œè´£ä»»è¾¹ç•Œ
- æ·±åº¦ä¼˜äºå¹¿åº¦çš„èƒ½åŠ›è®¾è®¡

### 2. å·¥å…·é€‰æ‹©åŸåˆ™  
- **æœ€å°æƒé™åŸåˆ™**: åªé€‰æ‹©ç»å¯¹å¿…è¦çš„å·¥å…·
- **èƒ½åŠ›åŒ¹é…åŸåˆ™**: å·¥å…·åŠŸèƒ½ä¸æ™ºèƒ½ä½“ä»»åŠ¡é«˜åº¦åŒ¹é…
- **ç»„åˆååŒåŸåˆ™**: å¤šä¸ªå·¥å…·ååŒå®Œæˆå¤æ‚ä»»åŠ¡
- **å®‰å…¨çº¦æŸåŸåˆ™**: é¿å…é€‰æ‹©ä¸å®‰å…¨æˆ–ä¸ç¨³å®šçš„å·¥å…·

å¯ç”¨å·¥å…·é›†åˆ:
{TOOLS}

### 3. LLMç±»å‹é€‰æ‹©
- **basic**: åŸºç¡€å¯¹è¯å’Œç®€å•ä»»åŠ¡
- **reasoning**: å¤æ‚æ¨ç†ã€åˆ†æå’Œè§„åˆ’  
- **vision**: å›¾åƒå¤„ç†å’Œè§†è§‰åˆ†æ

### 4. æç¤ºè¯å·¥ç¨‹
- æ¸…æ™°çš„è§’è‰²å®šä¹‰å’Œèƒ½åŠ›æè¿°
- å…·ä½“çš„ä»»åŠ¡æ‰§è¡ŒæŒ‡å¯¼
- æœ‰æ•ˆçš„è¾“å‡ºæ ¼å¼æ§åˆ¶
- é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µè¯´æ˜

## è¾“å‡ºæ ¼å¼ (ç»“æ„åŒ–JSON)
```typescript
interface AgentBuilder {
  agent_name: string;           // æ™ºèƒ½ä½“å”¯ä¸€æ ‡è¯†
  agent_description: string;    // åŠŸèƒ½æè¿°
  thought: string;             // è®¾è®¡æ€è·¯
  llm_type: "basic"|"reasoning"|"vision";  // LLMç±»å‹é€‰æ‹©
  selected_tools: Tool[];      // å·¥å…·é€‰æ‹©
  prompt: string;              // æ‰§è¡Œæç¤ºè¯
}

interface Tool {
  name: string;                // å·¥å…·åç§°
  reason: string;              // é€‰æ‹©ç†ç”±
}
```

## å·¥å…·é€‰æ‹©æµç¨‹
1. åˆ†ææ™ºèƒ½ä½“çš„æ ¸å¿ƒä»»åŠ¡éœ€æ±‚
2. éå†å¯ç”¨å·¥å…·åˆ—è¡¨
3. è¯„ä¼°æ¯ä¸ªå·¥å…·çš„å¿…è¦æ€§ï¼š"æ²¡æœ‰è¿™ä¸ªå·¥å…·èƒ½å®Œæˆä»»åŠ¡å—ï¼Ÿ"
4. å¦‚æœç­”æ¡ˆæ˜¯"èƒ½"ï¼Œåˆ™ä¸é€‰æ‹©è¯¥å·¥å…·
5. ç”Ÿæˆå·¥å…·é€‰æ‹©çš„æ˜ç¡®ç†ç”±

## å½“å‰åˆ›å»ºåœºæ™¯
- ç”¨æˆ·éœ€æ±‚: {USER_QUERY}
- ç°æœ‰å›¢é˜Ÿ: {TEAM_MEMBERS}
- ä¸Šä¸‹æ–‡ä¿¡æ¯: {context}
```

### 2.2 ç»„ä»¶éœ€æ±‚åˆ†æçš„å¤§æ¨¡å‹æ™ºæ…§ä½“ç°

#### åŠ¨æ€ç»„ä»¶é€‰æ‹©é€»è¾‘

```python
# src/generator/cooragent_generator.py
def _determine_required_components(self, agents: List[Agent], tools: set) -> Dict[str, List[str]]:
    """ç¡®å®šéœ€è¦å¤åˆ¶çš„Cooragentç»„ä»¶ - å¤§æ¨¡å‹æ™ºæ…§æŒ‡å¯¼çš„ç»„ä»¶åˆ†æ"""
    
    log_with_line(gen_logger.debug, f"COMPONENT_ANALYSIS_START:")                      # line:533
    log_with_line(gen_logger.debug, f"  â”œâ”€ analyzing_agents: {[a.agent_name for a in agents]}")  # line:534
    log_with_line(gen_logger.debug, f"  â”œâ”€ analyzing_tools: {list(tools)}")           # line:535
    log_with_line(gen_logger.debug, f"  â””â”€ determining_required_components...")        # line:536
    
    components = {
        # æ ¸å¿ƒç»„ä»¶ (æ€»æ˜¯éœ€è¦)
        "interface": self.core_components["interface"],                                # line:539
        "workflow": self.core_components["workflow"],                                  # line:540
        "manager": self.core_components["manager"],                                    # line:541
        "llm": self.core_components["llm"],                                           # line:542
        "prompts": self.core_components["prompts"],                                   # line:543
        "utils": self.core_components["utils"],                                       # line:544
        "service": self.core_components["service"],                                   # line:545
        
        # ğŸ“Š åŸºäºå¤§æ¨¡å‹åˆ†æç»“æœçš„åŠ¨æ€ç»„ä»¶é€‰æ‹©
        "tools": [],                                                                  # line:548
        "prompts_md": ["coordinator.md", "template.py"]  # ç³»ç»Ÿæç¤ºè¯               # line:549
    }
    
    # ğŸ”§ æ ¹æ®ä½¿ç”¨çš„å·¥å…·ç¡®å®šéœ€è¦å¤åˆ¶çš„å·¥å…·æ–‡ä»¶
    log_with_line(gen_logger.debug, f"TOOL_COMPONENT_MAPPING:")                      # line:552
    for tool in tools:                                                               # line:553
        if tool in self.tool_mapping:                                                # line:554
            mapped_files = self.tool_mapping[tool]                                   # line:555
            components["tools"].extend(mapped_files)                                 # line:556
            log_with_line(gen_logger.debug, f"  â”œâ”€ {tool} -> {mapped_files}")       # line:557
        else:
            log_with_line(gen_logger.warning, f"  âŒ unknown_tool: {tool}")          # line:559
    
    # å»é‡å·¥å…·æ–‡ä»¶
    components["tools"] = list(set(components["tools"]))                             # line:562
    log_with_line(gen_logger.debug, f"  â””â”€ final_tools: {components['tools']}")     # line:563
    
    # ğŸ“‹ æ ¹æ®æ™ºèƒ½ä½“ç¡®å®šéœ€è¦çš„æç¤ºè¯æ–‡ä»¶
    agent_prompts = set()                                                            # line:566
    log_with_line(gen_logger.debug, f"AGENT_PROMPT_MAPPING:")                       # line:567
    for agent in agents:                                                             # line:568
        if hasattr(agent, 'agent_name') and agent.agent_name:                       # line:569
            prompt_file = f"{agent.agent_name}.md"                                  # line:570
            agent_prompts.add(prompt_file)                                           # line:571
            log_with_line(gen_logger.debug, f"  â”œâ”€ {agent.agent_name} -> {prompt_file}")  # line:572
    
    components["prompts_md"].extend(list(agent_prompts))                             # line:574
    components["prompts_md"] = list(set(components["prompts_md"]))                   # line:575
    log_with_line(gen_logger.debug, f"  â””â”€ final_prompts: {components['prompts_md']}")  # line:576
    
    log_with_line(gen_logger.info, f"ğŸ“¦ COMPONENT_ANALYSIS_COMPLETE:")              # line:578
    log_with_line(gen_logger.debug, f"  â”œâ”€ core_components: {len(components) - 2}")  # line:579
    log_with_line(gen_logger.debug, f"  â”œâ”€ tool_files: {len(components['tools'])}")  # line:580
    log_with_line(gen_logger.debug, f"  â””â”€ prompt_files: {len(components['prompts_md'])}")  # line:581
    
    return components                                                                # line:583
```

## 3. æ€»ç»“ï¼šå¤§æ¨¡å‹æ™ºæ…§åœ¨éœ€æ±‚åˆ†æä¸­çš„æ ¸å¿ƒä»·å€¼

### 3.1 æ™ºèƒ½ç†è§£å±‚é¢
- **è‡ªç„¶è¯­è¨€ç†è§£**: å‡†ç¡®è§£æç”¨æˆ·çš„æ¨¡ç³Šéœ€æ±‚å’Œéšå«æ„å›¾
- **ä¸Šä¸‹æ–‡æ¨ç†**: åŸºäºå¯¹è¯å†å²å’Œç³»ç»ŸçŠ¶æ€åšå‡ºæ™ºèƒ½å†³ç­–
- **é¢†åŸŸçŸ¥è¯†åº”ç”¨**: åˆ©ç”¨é¢„è®­ç»ƒçŸ¥è¯†ç†è§£ä¸“ä¸šæœ¯è¯­å’Œæ¦‚å¿µ

### 3.2 æ™ºèƒ½å†³ç­–å±‚é¢  
- **åˆ†ç±»å†³ç­–**: Coordinatoræ™ºèƒ½åŒºåˆ†ç®€å•ä»»åŠ¡å’Œå¤æ‚ä»»åŠ¡
- **è§„åˆ’å†³ç­–**: Planneråˆ¶å®šæœ€ä¼˜çš„æ™ºèƒ½ä½“åä½œæ–¹æ¡ˆ
- **æ¶æ„å†³ç­–**: Agent Factoryè®¾è®¡ä¸“ä¸šåŒ–çš„æ™ºèƒ½ä½“é…ç½®

### 3.3 ç»“æ„åŒ–è¾“å‡ºå±‚é¢
- **æ ¼å¼æ§åˆ¶**: é€šè¿‡ç»“æ„åŒ–è¾“å‡ºç¡®ä¿LLMè¾“å‡ºç¬¦åˆç³»ç»Ÿè¦æ±‚
- **ç±»å‹å®‰å…¨**: TypeScriptæ¥å£å®šä¹‰ä¿è¯æ•°æ®ç»“æ„çš„ä¸€è‡´æ€§
- **é”™è¯¯å¤„ç†**: è‡ªåŠ¨éªŒè¯å’Œçº æ­£LLMè¾“å‡ºçš„æ ¼å¼é”™è¯¯

### 3.4 æç¤ºè¯å·¥ç¨‹ä»·å€¼
- **ç²¾ç¡®æŒ‡å¯¼**: è¯¦ç»†çš„æç¤ºè¯æ¨¡æ¿ç¡®ä¿LLMç†è§£ä»»åŠ¡è¦æ±‚
- **ä¸Šä¸‹æ–‡æ³¨å…¥**: åŠ¨æ€å˜é‡è®©LLMè·å¾—å®æ—¶ç³»ç»ŸçŠ¶æ€
- **Few-shotå­¦ä¹ **: ç¤ºä¾‹å¼•å¯¼LLMäº§ç”Ÿé«˜è´¨é‡è¾“å‡º
- **ä¸€è‡´æ€§ä¿è¯**: æ¨¡æ¿åŒ–æç¤ºè¯ç¡®ä¿è¾“å‡ºæ ¼å¼çš„æ ‡å‡†åŒ–

é€šè¿‡è¿™ç§å¤šå±‚æ¬¡çš„å¤§æ¨¡å‹æ™ºæ…§åº”ç”¨å’Œç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯å·¥ç¨‹ï¼ŒCooragentå®ç°äº†ä»è‡ªç„¶è¯­è¨€éœ€æ±‚åˆ°å¯æ‰§è¡Œä»£ç çš„å®Œå…¨è‡ªåŠ¨åŒ–è½¬æ¢ï¼Œå±•ç°äº†AIç³»ç»Ÿåœ¨å¤æ‚ä»»åŠ¡åˆ†è§£å’Œæ™ºèƒ½å†³ç­–æ–¹é¢çš„å¼ºå¤§èƒ½åŠ›ã€‚ 