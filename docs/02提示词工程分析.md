# 提示词工程分析：多智能体协作的核心驱动机制

## 概述

Cooragent的提示词工程系统是实现"一句话生成多智能体代码"的核心驱动机制。通过精心设计的提示词模板，系统能够将自然语言需求自动转化为智能体协作工作流，实现从用户意图到代码执行的全自动化流程。

## 提示词工程架构

### 核心模板系统

#### `template.py` - 提示词模板引擎
**作用**: 提示词系统的底层基础设施
**核心功能**:
- `get_prompt_template()`: 读取和解析markdown格式的提示词模板
- `apply_prompt_template()`: 将动态状态数据注入模板生成完整提示词
- `apply_prompt()`: 智能体运行时提示词应用
- `apply_polish_template()`: 智能体优化模板应用

**技术特点**:
- 支持`<<VAR>>`格式的变量占位符
- 自动转义JSON特殊字符
- 动态时间注入(`CURRENT_TIME`)
- 状态数据深拷贝避免污染

**核心价值**: 提供统一的提示词模板管理和动态生成能力，确保所有智能体都能获得一致的上下文信息。

## 系统级智能体提示词

### 1. `coordinator.md` - 用户请求分类器
**使用时机**: 系统接收到用户输入的第一时间
**核心作用**: 智能分类用户请求，决定处理路径

**分类协议**:
- **协议1 - 直接回复**: 处理简单问答、闲聊、基础计算等
- **协议2 - 任务移交**: 处理复杂任务，调用`handover_to_planner()`

**设计亮点**:
- 严格的二分类逻辑，避免判断模糊
- 语言一致性要求（用户中文输入，必须中文回复）
- 清洁接口原则，不暴露内部思考过程
- 丰富的Few-shot样例覆盖常见场景

**核心价值**: 作为系统的"智能前台"，高效过滤简单请求，将复杂任务准确路由到规划系统。

### 2. `planner.md` - 任务规划专家
**使用时机**: coordinator判定需要复杂处理的任务
**核心作用**: 分析任务需求，制定智能体协作方案

**规划能力**:
- 任务分解和步骤规划
- 智能体选择和能力匹配
- 新智能体需求识别
- 执行顺序优化

**输出格式** (`PlanWithAgents`):
```typescript
interface PlanWithAgents {
  thought: string;          // 规划思路
  title: string;           // 任务标题
  new_agents_needed: NewAgent[];  // 新智能体需求
  steps: Step[];           // 执行步骤
}
```

**设计约束**:
- 每个智能体(除reporter)只能使用一次
- 必须使用reporter作为最后步骤生成报告
- 语言一致性严格要求
- coder专门负责数学计算和图表绘制

**核心价值**: 作为系统的"大脑"，将用户的自然语言需求转化为可执行的智能体协作计划。

### 3. `publisher.md` - 任务分发器
**使用时机**: 获得规划方案后，按步骤执行任务分发
**核心作用**: 严格按照规划步骤控制任务执行流程

**执行逻辑**:
- 解析`steps`数组获取执行计划
- 追踪`{"next": "agent_name"}`记录
- 按序分发任务给相应智能体
- 判断任务结束条件

**输出格式**: 严格的JSON格式`{"next": "agent_name"}`或`{"next": "FINISH"}`

**设计特点**:
- 零容错的JSON输出要求
- 精确的执行顺序控制
- 明确的任务终止判断

**核心价值**: 作为系统的"指挥官"，确保智能体按照既定计划有序协作，避免执行混乱。

### 4. `agent_factory.md` - 智能体动态创建器
**使用时机**: 现有智能体无法满足特定需求时
**核心作用**: 根据需求规格动态创建新的专业智能体

**创建流程**:
1. 解析`new_agents_needed`规格说明
2. 分析任务复杂度选择LLM类型
3. 精选必要工具集合
4. 构建专业化提示词
5. 生成完整智能体配置

**输出格式** (`AgentBuilder`):
```typescript
interface AgentBuilder {
  agent_name: string;
  agent_description: string;
  thought: string;
  llm_type: string;
  selected_tools: Tool[];
  prompt: string;
}
```

**关键约束**:
- 禁止使用自身名称作为新智能体名称
- 严格禁用`yfinance`工具
- 工具选择遵循"最小特权原则"
- 生成的提示词必须包含Role、Steps、Notes结构

**核心价值**: 实现系统的"自我进化"能力，根据用户需求动态扩展智能体生态。

### 5. `agent_factory_planner.md` - 智能体需求分析器
**使用时机**: Agent Factory模式下的需求分析阶段
**核心作用**: 评估现有智能体能力，决定是否需要创建新智能体

**设计哲学**:
- **通用性优先**: 创建可复用的通用智能体
- **参数化设计**: 具体需求作为运行时参数
- **能力评估**: 优先使用现有智能体组合

**核心约束**:
- 语言一致性是最高优先级错误
- 智能体定义必须通用化，不能包含具体地名、人名、数字
- 必须先评估现有智能体能力

**核心价值**: 确保智能体生态的健康发展，避免创建冗余或过度专化的智能体。

## 执行级智能体提示词

### 1. `researcher.md` - 信息收集专家
**专业领域**: 网络搜索和信息收集
**工具配置**: `tavily_tool` + `crawl_tool`
**使用时机**: 需要获取外部信息或验证事实时

**工作流程**:
1. 解析任务描述识别搜索需求
2. 使用tavily_tool执行关键词搜索
3. 使用crawl_tool深度爬取相关URL内容
4. 综合分析生成结构化报告

**输出格式**:
- 问题陈述
- 搜索结果摘要
- 爬取内容分析
- 综合结论

**设计约束**:
- 严禁数学计算和文件操作
- 只能爬取内容，不能与页面交互
- 必须验证信息可信度和相关性

### 2. `coder.md` - 代码执行专家
**专业领域**: Python编程和Bash脚本
**工具配置**: `python_repl_tool` + `bash_tool`
**使用时机**: 需要数据分析、计算、图表生成、系统操作时

**工作流程**:
1. 自动解析多个coder任务，识别未执行的任务
2. 分析需求选择Python/Bash/混合方案
3. 实现解决方案并充分使用print()调试
4. 测试验证并处理边界情况
5. 文档化实现方法和结果

**设计特点**:
- 支持Python和Bash无缝集成
- 强调调试输出和错误处理
- 使用相对路径进行文件操作
- 自动安装缺失的Python库

**专业约束**:
- 不使用plt.show()等阻塞命令
- 图表生成不显示，直接保存
- 优先使用相对路径，明确告知后续智能体路径信息

### 3. `browser.md` - 网页操作专家
**专业领域**: 网页浏览和内容提取
**工具配置**: `browser_tool`
**使用时机**: 需要访问特定网站或进行网页交互时

**工作能力**:
- 访问指定URL获取网页内容
- 分析HTML结构提取关键信息
- 适应中国大陆网络环境（推荐Bing/百度搜索）

**设计约束**:
- 只能获取HTML内容，不能执行JavaScript
- 不能进行数学计算或文件操作
- 需要处理访问失败的替代方案

### 4. `reporter.md` - 报告生成专家
**专业领域**: 信息整理和报告撰写
**工具配置**: 无工具依赖，纯文本处理
**使用时机**: 作为工作流的最后环节，整理所有结果

**报告结构**:
- 执行摘要
- 关键发现
- 详细分析
- 结论和建议

**特殊能力**:
- 支持ECharts图表格式输出
- 严格基于提供信息，不编造内容
- 专业的Markdown格式化

**设计原则**:
- 客观性：只基于已提供的事实
- 完整性：明确标注信息缺失
- 专业性：使用清晰的报告结构

## 系统级功能提示词

### `agent_polish.md` - 智能体优化器
**使用时机**: Polish模式下需要优化现有智能体时
**核心作用**: 根据用户指令动态修改智能体的提示词和描述

**优化能力**:
- 分析现有智能体的角色、工具、提示词
- 理解用户的修改意图
- 重构提示词保持结构完整性
- 更新智能体描述确保一致性

**设计要求**:
- 保持提示词的清晰性和详细性
- 确保工具使用的合理性
- 维护语言一致性
- 包含完整的Role、Task、Steps、Notes结构

## 提示词工程的核心价值

### 1. 智能化的任务理解
通过coordinator的精准分类和planner的深度分析，系统能够理解用户的真实意图，将自然语言转化为可执行的技术方案。

### 2. 动态的能力扩展
通过agent_factory的动态创建机制，系统具备了自我进化的能力，可以根据需求创建新的专业智能体。

### 3. 严格的执行控制
通过publisher的精确调度和各执行智能体的专业化分工，确保复杂任务的有序执行。

### 4. 高质量的结果输出
通过reporter的专业整理和标准化输出格式，确保最终结果的专业性和可用性。

### 5. 语言一致性保障
所有提示词都严格要求语言一致性，确保系统在多语言环境下的稳定表现。

## 协作机制分析

### 工作流驱动的协作模式
```
用户输入 → coordinator(分类) → planner(规划) → publisher(分发) → 执行智能体协作 → reporter(汇总)
```

### 状态传递机制
- 每个智能体通过State对象获取上下文信息
- 动态变量注入确保提示词的实时性
- 历史消息传递保持对话连续性

### 工具共享机制
- 研究员专用: tavily_tool + crawl_tool
- 编程员专用: python_repl_tool + bash_tool  
- 浏览器专用: browser_tool
- 报告员专用: 无工具依赖

### 质量保障机制
- Few-shot样例提供标准参考
- 严格的输出格式要求
- 多层次的错误处理
- 语言一致性检查

## 技术创新点

### 1. 模板驱动的动态生成
使用markdown模板 + 变量注入的方式，实现了提示词的动态生成和复用。

### 2. 角色专业化设计
每个智能体都有明确的专业领域和工具配置，避免功能重叠和责任模糊。

### 3. 自适应的智能体创建
通过agent_factory实现了智能体的按需创建，极大扩展了系统的适应性。

### 4. 严格的执行顺序控制
通过publisher的精确调度，确保了复杂工作流的有序执行。

### 5. 多模式运行支持
同一套提示词系统支持Launch、Polish、Production三种不同的运行模式。

## 总结

Cooragent的提示词工程系统通过精心设计的分层架构和专业化分工，实现了从"一句话需求"到"多智能体协作执行"的全自动化转换。这套系统的核心价值在于：

1. **智能理解**: 准确理解用户的自然语言需求
2. **动态规划**: 自动制定最优的执行方案
3. **精确执行**: 确保复杂任务的有序完成  
4. **持续进化**: 支持智能体的动态创建和优化

这种设计模式为构建大规模、自适应的多智能体系统提供了重要的技术参考和实践范例。 