# 新版本本地开发环境启动指南

## 📋 概述

本文档提供了旅游多智能体系统的最新启动方法，修复了前后端接口调用逻辑，支持后台运行和完整的日志监控功能。

## 🛠️ 环境要求

- **Python**: 3.7+ (推荐3.12+)
- **Node.js**: 用于前端开发服务器 (可选)
- **操作系统**: macOS、Linux、Windows
- **内存**: 至少4GB
- **磁盘空间**: 至少2GB可用空间

## 🚀 快速启动

### 方式一：一键启动脚本（推荐）

```bash
# 克隆项目
git clone https://github.com/your-repo/cooragent.git
cd cooragent

# 一键启动（后台运行 + 日志监控）
./start_with_backend_logs.sh
```

### 方式二：手动启动

```bash
# 1. 设置环境变量
export PYTHONPATH="/Users/a1/work/cooragent/src:/Users/a1/work/cooragent"
export PYTHONUNBUFFERED=1

# 2. 启动后台API服务器
python generator_cli.py server --host 0.0.0.0 --port 8000 &

# 3. 启动前端服务器
python3 -m http.server 8888 &
```

## 📡 服务地址

启动成功后，可以通过以下地址访问：

- **前端界面**: http://localhost:8888
- **后台API**: http://localhost:8000  
- **API文档**: http://localhost:8000/docs
- **健康检查**: http://localhost:8000/health

## 🔧 脚本功能特性

### `start_with_backend_logs.sh` 启动脚本

**🌟 核心功能：**
- ✅ 自动检测并停止现有服务
- ✅ 智能conda环境检测和激活
- ✅ 系统Python兼容性支持
- ✅ 完整的日志目录管理
- ✅ 后台服务启动和监控
- ✅ 服务健康检查
- ✅ 进程信息保存和管理

**📊 日志管理：**
- 后台日志：`logs/backend/generator.log`
- 前端日志：`logs/frontend/python_server.log`
- 服务信息：`logs/service_pids.txt`

**🛡️ 错误处理：**
- 端口冲突自动处理
- 环境依赖智能检测
- 服务启动状态验证
- 详细错误信息提示

### `stop_services.sh` 停止脚本

**🛑 停止功能：**
- 优雅停止保存的进程
- 强制清理端口占用
- 自动清理临时文件
- 服务状态验证

## 🔍 故障排除

### 常见问题及解决方案

#### 1. Conda环境问题
```bash
# 错误：无法激活conda环境
# 解决：脚本会自动使用系统Python，无需手动处理
```

#### 2. 端口占用问题
```bash
# 错误：端口8000或8888被占用
# 解决：脚本会自动停止占用端口的进程

# 手动停止端口进程
lsof -ti:8000 | xargs kill -9
lsof -ti:8888 | xargs kill -9
```

#### 3. 权限问题
```bash
# 错误：Permission denied
# 解决：给脚本添加执行权限
chmod +x start_with_backend_logs.sh stop_services.sh
```

#### 4. Python依赖问题
```bash
# 错误：ModuleNotFoundError
# 解决：安装项目依赖
pip install -e .
```

### 日志查看命令

```bash
# 实时查看后台日志
tail -f logs/backend/generator.log

# 实时查看前端日志  
tail -f logs/frontend/python_server.log

# 同时查看所有日志
tail -f logs/backend/generator.log logs/frontend/python_server.log

# 查看最近的错误
grep -i error logs/backend/generator.log | tail -10
```

## 🧪 功能测试

### API接口测试

```bash
# 健康检查
curl http://localhost:8000/health

# 旅游规划测试
curl -X POST http://localhost:8000/api/generate \
  -H "Content-Type: application/json" \
  -d '{"requirement": "帮我规划一个3天的北京旅游行程", "workflow_mode": "production"}'

# 查看API文档
open http://localhost:8000/docs
```

### 前端界面测试

1. 访问 http://localhost:8888
2. 输入旅游需求："规划一个上海3日游"
3. 点击生成按钮
4. 等待智能体处理并查看结果

## ⚙️ 高级配置

### 环境变量配置

在项目根目录创建或修改 `.env` 文件：

```bash
# 基础模型配置
REASONING_API_KEY=your_api_key
REASONING_BASE_URL=https://api.openai.com/v1
REASONING_MODEL=gpt-4

# 代码生成模型
CODE_API_KEY=your_api_key
CODE_BASE_URL=https://api.openai.com/v1
CODE_MODEL=gpt-4

# 多模态模型
VL_API_KEY=your_api_key
VL_BASE_URL=https://api.openai.com/v1
VL_MODEL=gpt-4-vision-preview

# 工具API密钥
TAVILY_API_KEY=your_tavily_key
JINA_API_KEY=your_jina_key

# 调试配置
DEBUG=true
APP_ENV=development
MAX_STEPS=50
```

### 自定义端口

如需使用其他端口，修改启动脚本中的端口配置：

```bash
# 修改后台端口（默认8000）
python generator_cli.py server --host 0.0.0.0 --port 9000

# 修改前端端口（默认8888）
python3 -m http.server 9888
```

## 📈 性能优化

### 系统配置优化

```bash
# 增加文件描述符限制
ulimit -n 65536

# 设置Python优化
export PYTHONUNBUFFERED=1
export PYTHONOPTIMIZE=1
```

### 内存优化

```bash
# 设置Python内存限制
export PYTHONMALLOC=malloc

# 垃圾回收优化
export PYTHONHASHSEED=0
```

## 🔄 开发模式

### 热重载开发

```bash
# 使用uvicorn的热重载功能
uvicorn src.service.server:app --host 0.0.0.0 --port 8000 --reload

# 监控文件变化
watch -n 1 'ls -la src/'
```

### 调试模式

```bash
# 启用详细日志
export DEBUG=true

# 启动调试服务器
python generator_cli.py server --host 0.0.0.0 --port 8000 --debug
```

## 📦 部署配置

### Docker部署

```bash
# 构建镜像
docker build -t cooragent:latest .

# 运行容器
docker run -d -p 8000:8000 -p 8888:8888 \
  --name cooragent \
  -v $(pwd)/logs:/app/logs \
  cooragent:latest
```

### 生产环境

```bash
# 使用gunicorn部署
pip install gunicorn
gunicorn src.service.server:app -w 4 -b 0.0.0.0:8000

# 使用nginx反向代理
# 配置nginx.conf指向localhost:8000
```

## 📋 检查清单

启动前请确认以下项目：

- [ ] Python环境正常 (`python --version`)
- [ ] 项目依赖已安装 (`pip list | grep fastapi`)
- [ ] 端口8000和8888未被占用
- [ ] `.env`文件已配置API密钥
- [ ] 项目目录权限正常
- [ ] 网络连接正常

## 🆘 技术支持

如遇到问题，请按以下步骤排查：

1. **查看日志文件** - 检查 `logs/` 目录下的日志
2. **检查进程状态** - 使用 `ps aux | grep generator_cli`
3. **验证端口状态** - 使用 `lsof -i :8000`
4. **测试网络连接** - 使用 `curl http://localhost:8000/health`
5. **重启服务** - 运行 `./stop_services.sh && ./start_with_backend_logs.sh`

## 📝 更新日志

- **2025-08-08**: 创建新版本启动文档
  - 修复conda环境检测问题
  - 优化前端服务器启动方式
  - 增加完整的日志监控功能
  - 添加自动化脚本和错误处理
  - 完善故障排除指南

---

**📧 联系我们**: 如有问题或建议，请提交GitHub Issue或联系开发团队。