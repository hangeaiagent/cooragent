<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…æ¸¸è§„åˆ’æ™ºèƒ½ä½“</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Markdownæ”¯æŒ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .markdown-content {
            line-height: 1.8;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.3rem; }
        .markdown-content h3 { font-size: 1.1rem; }
        .markdown-content ul, .markdown-content ol {
            margin-left: 2rem;
            margin-bottom: 1rem;
        }
        .markdown-content li {
            margin-bottom: 0.5rem;
        }
        .progress-bar {
            background-color: #3498db;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="gradient-bg min-h-screen">
        <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
        <div class="absolute top-4 right-4 z-10">
            <div class="bg-white rounded-lg p-1 shadow-md">
                <button id="langZH" class="px-3 py-2 rounded text-sm font-semibold bg-blue-600 text-white">ä¸­æ–‡</button>
                <button id="langEN" class="px-3 py-2 rounded text-sm font-semibold text-gray-700 hover:bg-gray-100">English</button>
            </div>
        </div>
        
        <div class="container mx-auto px-4 py-8">
            <!-- å¤´éƒ¨ -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">
                    <i class="fas fa-plane-departure mr-3"></i>
                    <span data-lang-key="page-title">æ—…æ¸¸è§„åˆ’æ™ºèƒ½ä½“</span>
                </h1>
                <p class="text-white text-lg opacity-90" data-lang-key="page-subtitle">è®©AIä¸ºæ‚¨å®šåˆ¶å®Œç¾çš„æ—…è¡Œè®¡åˆ’å’Œæ—…æ¸¸å’¨è¯¢</p>
            </div>

            <!-- åŠŸèƒ½é€‰æ‹©æ ‡ç­¾ -->
            <div class="flex justify-center mb-6">
                <div class="bg-white rounded-lg p-1 shadow-lg">
                    <button id="planningTab" class="px-6 py-3 rounded-md text-white font-semibold bg-blue-600 transition duration-300">
                        <i class="fas fa-route mr-2"></i><span data-lang-key="tab-planning">æ—…æ¸¸è§„åˆ’</span>
                    </button>
                    <button id="consultationTab" class="px-6 py-3 rounded-md text-gray-700 font-semibold hover:bg-gray-100 transition duration-300">
                        <i class="fas fa-question-circle mr-2"></i><span data-lang-key="tab-consultation">æ—…æ¸¸å’¨è¯¢</span>
                    </button>
                </div>
            </div>

            <!-- æ—…æ¸¸å’¨è¯¢åŒºåŸŸ -->
            <div id="consultationArea" class="max-w-4xl mx-auto mb-8 hidden">
                <div class="result-card rounded-lg p-6 shadow-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-comments mr-2"></i><span data-lang-key="consultation-title">æ—…æ¸¸å’¨è¯¢</span>
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2" data-lang-key="consultation-label">è¯·è¾“å…¥æ‚¨æƒ³å’¨è¯¢çš„æ—…æ¸¸é—®é¢˜æˆ–ç›®çš„åœ°æ—…æ¸¸æ™¯åŒºã€é¤é¥®ç­‰è¿›è¡Œ</label>
                            <textarea id="consultationQuestion" 
                                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                rows="4" 
                                data-lang-key="consultation-placeholder"
                                placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬æœ‰ä»€ä¹ˆå¥½ç©çš„ï¼Ÿä¸Šæµ·æœ‰å“ªäº›å¿…å»æ™¯ç‚¹ï¼Ÿä¸‰äºšç¾é£Ÿæ¨èç­‰..."></textarea>
                        </div>
                        <button id="consultationBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            <i class="fas fa-search mr-2"></i><span data-lang-key="consultation-btn">å¼€å§‹å’¨è¯¢</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥è¡¨å• -->
            <div id="planningArea" class="max-w-4xl mx-auto mb-8">
                <div class="result-card rounded-lg p-6 shadow-xl">
                    <form id="planningForm" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-map-marker-alt mr-2"></i><span data-lang-key="form-departure">å‡ºå‘åœ°</span>
                                </label>
                                <input type="text" id="departure" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                       data-lang-key="departure-placeholder" placeholder="è¯·è¾“å…¥å‡ºå‘åŸå¸‚ï¼Œå¦‚ï¼šåŒ—äº¬" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-map-marker-alt mr-2"></i><span data-lang-key="form-destination">ç›®çš„åœ°</span>
                                </label>
                                <input type="text" id="destination" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                       data-lang-key="destination-placeholder" placeholder="è¯·è¾“å…¥ç›®æ ‡åŸå¸‚ï¼Œå¦‚ï¼šæˆéƒ½" required>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-calendar-alt mr-2"></i><span data-lang-key="form-start-date">å‡ºå‘æ—¥æœŸ</span>
                                </label>
                                <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-calendar-check mr-2"></i><span data-lang-key="form-end-date">è¿”ç¨‹æ—¥æœŸ</span>
                                </label>
                                <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-users mr-2"></i><span data-lang-key="form-travelers">äººæ•°</span>
                                </label>
                                <select id="travelers" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="1" data-lang-key="travelers-1">1äºº</option>
                                    <option value="2" data-lang-key="travelers-2">2äºº</option>
                                    <option value="3" data-lang-key="travelers-3">3äºº</option>
                                    <option value="4" data-lang-key="travelers-4">4äºº</option>
                                    <option value="5+" data-lang-key="travelers-5">5äººä»¥ä¸Š</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-dollar-sign mr-2"></i><span data-lang-key="form-budget">é¢„ç®—èŒƒå›´ï¼ˆå…ƒï¼‰</span>
                                </label>
                                <select id="budget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="ç»æµå‹ï¼ˆ2000-5000ï¼‰" data-lang-key="budget-economy">ç»æµå‹ï¼ˆ2000-5000ï¼‰</option>
                                    <option value="èˆ’é€‚å‹ï¼ˆ5000-10000ï¼‰" data-lang-key="budget-comfort">èˆ’é€‚å‹ï¼ˆ5000-10000ï¼‰</option>
                                    <option value="è±ªåå‹ï¼ˆ10000+ï¼‰" data-lang-key="budget-luxury">è±ªåå‹ï¼ˆ10000+ï¼‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-heart mr-2"></i><span data-lang-key="form-preference">æ—…è¡Œåå¥½</span>
                                </label>
                                <select id="preference" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="æ–‡åŒ–å†å²" data-lang-key="pref-culture">æ–‡åŒ–å†å²</option>
                                    <option value="è‡ªç„¶é£å…‰" data-lang-key="pref-nature">è‡ªç„¶é£å…‰</option>
                                    <option value="ç¾é£Ÿä½“éªŒ" data-lang-key="pref-food">ç¾é£Ÿä½“éªŒ</option>
                                    <option value="ä¼‘é—²åº¦å‡" data-lang-key="pref-leisure">ä¼‘é—²åº¦å‡</option>
                                    <option value="å†’é™©åˆºæ¿€" data-lang-key="pref-adventure">å†’é™©åˆºæ¿€</option>
                                    <option value="ç»¼åˆä½“éªŒ" data-lang-key="pref-comprehensive">ç»¼åˆä½“éªŒ</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-comment mr-2"></i><span data-lang-key="form-special">ç‰¹æ®Šéœ€æ±‚ï¼ˆå¯é€‰ï¼‰</span>
                            </label>
                            <textarea id="specialRequests" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                      rows="3" data-lang-key="special-placeholder" placeholder="è¯·æè¿°æ‚¨çš„ç‰¹æ®Šéœ€æ±‚ï¼Œå¦‚ï¼šæ— éšœç¢è®¾æ–½ã€ç´ é£Ÿé¤å…ã€å„¿ç«¥å‹å¥½ç­‰"></textarea>
                        </div>

                        <div class="text-center">
                            <button type="submit" id="generateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 transform hover:scale-105">
                                <i class="fas fa-magic mr-2"></i>
                                <span data-lang-key="generate-btn">ç”Ÿæˆæ—…è¡Œè®¡åˆ’</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div id="progressContainer" class="max-w-4xl mx-auto mb-8 hidden">
                <div class="result-card rounded-lg p-6 shadow-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <span data-lang-key="progress-title">æ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¸“å±æ—…è¡Œè®¡åˆ’...</span>
                    </h3>
                    <div class="space-y-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600" data-lang-key="progress-status">åˆå§‹åŒ–ä¸­...</p>
                            <p class="text-sm text-blue-600 font-semibold">
                                <span class="progress-percentage">0</span>%
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div id="resultContainer" class="max-w-4xl mx-auto hidden">
                <div class="result-card rounded-lg p-6 shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-star mr-2"></i><span data-lang-key="result-title">æ‚¨çš„æ—…è¡Œè®¡åˆ’</span>
                        </h2>
                        <div class="space-x-2">
                            <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                <i class="fas fa-download mr-2"></i><span data-lang-key="export-btn">å¯¼å‡ºMarkdown</span>
                            </button>
                            <button id="newPlanBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                <i class="fas fa-plus mr-2"></i><span data-lang-key="new-plan-btn">æ–°å»ºè®¡åˆ’</span>
                            </button>
                        </div>
                    </div>
                    <div id="resultContent" class="markdown-content prose max-w-none">
                        <!-- ç»“æœå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¤šè¯­è¨€æ”¯æŒ
        const translations = {
            zh: {
                'page-title': 'æ—…æ¸¸è§„åˆ’æ™ºèƒ½ä½“',
                'page-subtitle': 'è®©AIä¸ºæ‚¨å®šåˆ¶å®Œç¾çš„æ—…è¡Œè®¡åˆ’å’Œæ—…æ¸¸å’¨è¯¢',
                'tab-planning': 'æ—…æ¸¸è§„åˆ’',
                'tab-consultation': 'æ—…æ¸¸å’¨è¯¢',
                'consultation-title': 'æ—…æ¸¸å’¨è¯¢',
                'consultation-label': 'è¯·è¾“å…¥æ‚¨æƒ³å’¨è¯¢çš„æ—…æ¸¸é—®é¢˜æˆ–ç›®çš„åœ°æ—…æ¸¸æ™¯åŒºã€é¤é¥®ç­‰è¿›è¡Œ',
                'consultation-placeholder': 'ä¾‹å¦‚ï¼šåŒ—äº¬æœ‰ä»€ä¹ˆå¥½ç©çš„ï¼Ÿä¸Šæµ·æœ‰å“ªäº›å¿…å»æ™¯ç‚¹ï¼Ÿä¸‰äºšç¾é£Ÿæ¨èç­‰...',
                'consultation-btn': 'å¼€å§‹å’¨è¯¢',
                'form-departure': 'å‡ºå‘åœ°',
                'form-destination': 'ç›®çš„åœ°',
                'form-start-date': 'å‡ºå‘æ—¥æœŸ',
                'form-end-date': 'è¿”ç¨‹æ—¥æœŸ',
                'form-travelers': 'äººæ•°',
                'form-budget': 'é¢„ç®—èŒƒå›´ï¼ˆå…ƒï¼‰',
                'form-preference': 'æ—…è¡Œåå¥½',
                'form-special': 'ç‰¹æ®Šéœ€æ±‚ï¼ˆå¯é€‰ï¼‰',
                'generate-btn': 'ç”Ÿæˆæ—…è¡Œè®¡åˆ’',
                'export-btn': 'å¯¼å‡ºMarkdown',
                'new-plan-btn': 'æ–°å»ºè®¡åˆ’',
                'progress-title': 'æ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¸“å±æ—…è¡Œè®¡åˆ’...',
                'progress-status': 'åˆå§‹åŒ–ä¸­...',
                'result-title': 'æ‚¨çš„æ—…è¡Œè®¡åˆ’',
                'departure-placeholder': 'è¯·è¾“å…¥å‡ºå‘åŸå¸‚ï¼Œå¦‚ï¼šåŒ—äº¬',
                'destination-placeholder': 'è¯·è¾“å…¥ç›®æ ‡åŸå¸‚ï¼Œå¦‚ï¼šæˆéƒ½',
                'special-placeholder': 'è¯·æè¿°æ‚¨çš„ç‰¹æ®Šéœ€æ±‚ï¼Œå¦‚ï¼šæ— éšœç¢è®¾æ–½ã€ç´ é£Ÿé¤å…ã€å„¿ç«¥å‹å¥½ç­‰',
                'travelers-1': '1äºº',
                'travelers-2': '2äºº',
                'travelers-3': '3äºº',
                'travelers-4': '4äºº',
                'travelers-5': '5äººä»¥ä¸Š',
                'budget-economy': 'ç»æµå‹ï¼ˆ2000-5000ï¼‰',
                'budget-comfort': 'èˆ’é€‚å‹ï¼ˆ5000-10000ï¼‰',
                'budget-luxury': 'è±ªåå‹ï¼ˆ10000+ï¼‰',
                'pref-culture': 'æ–‡åŒ–å†å²',
                'pref-nature': 'è‡ªç„¶é£å…‰',
                'pref-food': 'ç¾é£Ÿä½“éªŒ',
                'pref-leisure': 'ä¼‘é—²åº¦å‡',
                'pref-adventure': 'å†’é™©åˆºæ¿€',
                'pref-comprehensive': 'ç»¼åˆä½“éªŒ'
            },
            en: {
                'page-title': 'Travel Planning AI Agent',
                'page-subtitle': 'Let AI customize perfect travel plans and tourism consultation for you',
                'tab-planning': 'Travel Planning',
                'tab-consultation': 'Travel Consultation',
                'consultation-title': 'Travel Consultation',
                'consultation-label': 'Please enter your travel questions or inquiries about destinations, attractions, dining, etc.',
                'consultation-placeholder': 'e.g., What are the fun places in Beijing? What are the must-visit attractions in Shanghai? Sanya food recommendations, etc...',
                'consultation-btn': 'Start Consultation',
                'form-departure': 'Departure',
                'form-destination': 'Destination',
                'form-start-date': 'Departure Date',
                'form-end-date': 'Return Date',
                'form-travelers': 'Travelers',
                'form-budget': 'Budget Range (CNY)',
                'form-preference': 'Travel Preference',
                'form-special': 'Special Requirements (Optional)',
                'generate-btn': 'Generate Travel Plan',
                'export-btn': 'Export Markdown',
                'new-plan-btn': 'New Plan',
                'progress-title': 'Generating your exclusive travel plan...',
                'progress-status': 'Initializing...',
                'result-title': 'Your Travel Plan',
                'departure-placeholder': 'Enter departure city, e.g., Beijing',
                'destination-placeholder': 'Enter destination city, e.g., Chengdu',
                'special-placeholder': 'Describe special requirements, e.g., accessibility, vegetarian restaurants, child-friendly, etc.',
                'travelers-1': '1 person',
                'travelers-2': '2 people',
                'travelers-3': '3 people',
                'travelers-4': '4 people',
                'travelers-5': '5+ people',
                'budget-economy': 'Economy (2000-5000 CNY)',
                'budget-comfort': 'Comfort (5000-10000 CNY)',
                'budget-luxury': 'Luxury (10000+ CNY)',
                'pref-culture': 'Culture & History',
                'pref-nature': 'Natural Scenery',
                'pref-food': 'Food Experience',
                'pref-leisure': 'Leisure & Vacation',
                'pref-adventure': 'Adventure & Excitement',
                'pref-comprehensive': 'Comprehensive Experience'
            }
        };

        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8000' : '';
        let currentTaskId = null;
        let currentLang = 'zh'; // é»˜è®¤ä¸­æ–‡

        // è¯­è¨€åˆ‡æ¢å‡½æ•°
        function switchLanguage(lang) {
            currentLang = lang;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('langZH').className = lang === 'zh' 
                ? 'px-3 py-2 rounded text-sm font-semibold bg-blue-600 text-white'
                : 'px-3 py-2 rounded text-sm font-semibold text-gray-700 hover:bg-gray-100';
            document.getElementById('langEN').className = lang === 'en' 
                ? 'px-3 py-2 rounded text-sm font-semibold bg-blue-600 text-white'
                : 'px-3 py-2 rounded text-sm font-semibold text-gray-700 hover:bg-gray-100';
            
            // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-lang-key çš„å…ƒç´ 
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });
            
            // ä¿å­˜è¯­è¨€é€‰æ‹©
            localStorage.setItem('preferredLanguage', lang);
        }

        // åˆå§‹åŒ–æ—¥æœŸå’Œæ ‡ç­¾åˆ‡æ¢
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥å¹¶åº”ç”¨ä¿å­˜çš„è¯­è¨€è®¾ç½®
            const savedLang = localStorage.getItem('preferredLanguage') || 'zh';
            switchLanguage(savedLang);
            
            // è¯­è¨€åˆ‡æ¢äº‹ä»¶ç›‘å¬
            document.getElementById('langZH').addEventListener('click', () => switchLanguage('zh'));
            document.getElementById('langEN').addEventListener('click', () => switchLanguage('en'));
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('startDate').valueAsDate = today;
            document.getElementById('endDate').valueAsDate = tomorrow;
            
            // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
            const planningTab = document.getElementById('planningTab');
            const consultationTab = document.getElementById('consultationTab');
            const planningArea = document.getElementById('planningArea');
            const consultationArea = document.getElementById('consultationArea');
            
            // åˆ‡æ¢åˆ°æ—…æ¸¸è§„åˆ’
            planningTab.addEventListener('click', function() {
                planningTab.className = 'px-6 py-3 rounded-md text-white font-semibold bg-blue-600 transition duration-300';
                consultationTab.className = 'px-6 py-3 rounded-md text-gray-700 font-semibold hover:bg-gray-100 transition duration-300';
                planningArea.classList.remove('hidden');
                consultationArea.classList.add('hidden');
            });
            
            // æ—…æ¸¸å’¨è¯¢æŒ‰é’®
            consultationTab.addEventListener('click', function() {
                consultationTab.className = 'px-6 py-3 rounded-md text-white font-semibold bg-blue-600 transition duration-300';
                planningTab.className = 'px-6 py-3 rounded-md text-gray-700 font-semibold hover:bg-gray-100 transition duration-300';
                consultationArea.classList.remove('hidden');
                planningArea.classList.add('hidden');
            });
        });

        // æ˜¾ç¤ºè¿›åº¦
        function showProgress() {
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
        }

        // éšè—è¿›åº¦
        function hideProgress() {
            document.getElementById('progressContainer').classList.add('hidden');
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percentage) {
            const progressBar = document.querySelector('.progress-bar');
            const progressPercentage = document.querySelector('.progress-percentage');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            if (progressPercentage) {
                progressPercentage.textContent = percentage;
            }
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('planningForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                departure: document.getElementById('departure').value,
                destination: document.getElementById('destination').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                travelers: document.getElementById('travelers').value,
                budget: document.getElementById('budget').value,
                preference: document.getElementById('preference').value,
                special_requests: document.getElementById('specialRequests').value
            };

            try {
                showProgress();
                updateProgress(10);
                
                const response = await fetch(`${API_BASE_URL}/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requirement: `æˆ‘æƒ³ä»${formData.departure}åˆ°${formData.destination}æ—…è¡Œï¼Œä»${formData.start_date}åˆ°${formData.end_date}ï¼Œå…±${formData.travelers}ï¼Œé¢„ç®—${formData.budget}ï¼Œåå¥½${formData.preference}ã€‚ç‰¹æ®Šéœ€æ±‚ï¼š${formData.special_requests}`,
                        workflow_mode: 'production'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                currentTaskId = data.task_id;
                
                updateProgress(20);
                
                // å¼€å§‹è½®è¯¢çŠ¶æ€
                pollStatus();
                
            } catch (error) {
                console.error('Error:', error);
                hideProgress();
                alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
            }
        });

        // æ—…æ¸¸å’¨è¯¢å¤„ç†å‡½æ•°
        document.getElementById('consultationBtn').addEventListener('click', async function() {
            const question = document.getElementById('consultationQuestion').value.trim();
            
            if (!question) {
                alert(currentLang === 'zh' ? 'è¯·è¾“å…¥æ‚¨çš„æ—…æ¸¸å’¨è¯¢é—®é¢˜' : 'Please enter your travel consultation question');
                return;
            }

            try {
                showProgress();
                updateProgress(10);
                
                const response = await fetch(`${API_BASE_URL}/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requirement: question,
                        workflow_mode: 'production'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                currentTaskId = data.task_id;
                
                updateProgress(20);
                
                // å¼€å§‹è½®è¯¢çŠ¶æ€
                pollConsultationStatus();
                
            } catch (error) {
                console.error('Error:', error);
                hideProgress();
                alert((currentLang === 'zh' ? 'å’¨è¯¢å¤±è´¥ï¼š' : 'Consultation failed: ') + error.message);
            }
        });

        // è½®è¯¢çŠ¶æ€
        async function pollStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate/${currentTaskId}/status`);
                const statusData = await response.json();
                
                if (statusData.progress !== undefined) {
                    updateProgress(statusData.progress);
                }
                
                if (statusData.status === 'completed') {
                    let result = statusData.travel_result;
                    if (!result) {
                        const resultResponse = await fetch(`${API_BASE_URL}/api/generate/${currentTaskId}/download`);
                        result = await resultResponse.text();
                    }
                    
                    displayResult(result);
                    hideProgress();
                } else if (statusData.status === 'failed') {
                    hideProgress();
                    throw new Error(statusData.error_details || 'ç”Ÿæˆå¤±è´¥');
                } else {
                    setTimeout(pollStatus, 1000);
                }
            } catch (error) {
                console.error('Error polling status:', error);
                hideProgress();
                alert((currentLang === 'zh' ? 'ç”Ÿæˆå¤±è´¥ï¼š' : 'Generation failed: ') + error.message);
            }
        }

        // è½®è¯¢å’¨è¯¢çŠ¶æ€
        async function pollConsultationStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate/${currentTaskId}/status`);
                const statusData = await response.json();
                
                if (statusData.progress !== undefined) {
                    updateProgress(statusData.progress);
                }
                
                if (statusData.status === 'completed') {
                    let result = statusData.travel_result;
                    if (!result) {
                        const resultResponse = await fetch(`${API_BASE_URL}/api/generate/${currentTaskId}/download`);
                        result = await resultResponse.text();
                    }
                    
                    displayResult(result);
                    hideProgress();
                } else if (statusData.status === 'failed') {
                    hideProgress();
                    throw new Error(statusData.error_details || 'å’¨è¯¢å¤„ç†å¤±è´¥');
                } else {
                    setTimeout(pollConsultationStatus, 1000);
                }
            } catch (error) {
                console.error('Error polling consultation status:', error);
                hideProgress();
                alert((currentLang === 'zh' ? 'å’¨è¯¢å¤„ç†å¤±è´¥ï¼š' : 'Consultation failed: ') + error.message);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(result) {
            const resultDiv = document.getElementById('resultContent');
            
            try {
                const htmlContent = marked.parse(result);
                const sanitizedContent = DOMPurify.sanitize(htmlContent);
                
                resultDiv.innerHTML = sanitizedContent;
                
                const resultContainer = document.getElementById('resultContainer');
                if (resultContainer) {
                    resultContainer.classList.remove('hidden');
                    resultContainer.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('æ˜¾ç¤ºç»“æœæ—¶å‡ºé”™:', error);
                resultDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded">${currentLang === 'zh' ? 'æ˜¾ç¤ºç»“æœæ—¶å‡ºé”™' : 'Error displaying result'}: ${error.message}</div>`;
            }
        }

        // å¯¼å‡ºMarkdown
        document.getElementById('exportBtn').addEventListener('click', function() {
            const content = document.getElementById('resultContent').innerHTML;
            
            let markdown = content
                .replace(/<h1>/g, '# ')
                .replace(/<\/h1>/g, '\n\n')
                .replace(/<h2>/g, '## ')
                .replace(/<\/h2>/g, '\n\n')
                .replace(/<h3>/g, '### ')
                .replace(/<\/h3>/g, '\n\n')
                .replace(/<ul>/g, '')
                .replace(/<\/ul>/g, '\n')
                .replace(/<li>/g, '- ')
                .replace(/<\/li>/g, '\n')
                .replace(/<strong>/g, '**')
                .replace(/<\/strong>/g, '**')
                .replace(/<em>/g, '*')
                .replace(/<\/em>/g, '*')
                .replace(/<p>/g, '')
                .replace(/<\/p>/g, '\n\n')
                .replace(/&nbsp;/g, ' ')
                .replace(/\n\s*\n\s*\n/g, '\n\n');

            markdown += `\n\n---\n\næœ¬æ—…æ¸¸è§„åˆ’ç”± [gitagent.io](https://gitagent.io) æ™ºèƒ½æ—…æ¸¸è§„åˆ’ç³»ç»Ÿç”Ÿæˆ\n\nğŸŒ è®¿é—®æˆ‘ä»¬ï¼š[https://gitagent.io](https://gitagent.io)`;

            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const isConsultation = markdown.includes('æ—…æ¸¸å’¨è¯¢å›ç­”');
            const filePrefix = isConsultation ? (currentLang === 'zh' ? 'æ—…æ¸¸å’¨è¯¢' : 'Travel_Consultation') : (currentLang === 'zh' ? 'æ—…è¡Œè®¡åˆ’' : 'Travel_Plan');
            a.download = `${filePrefix}_${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // æ–°å»ºè®¡åˆ’
        document.getElementById('newPlanBtn').addEventListener('click', function() {
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('planningForm').reset();
            document.getElementById('consultationQuestion').value = '';
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('startDate').valueAsDate = today;
            document.getElementById('endDate').valueAsDate = tomorrow;
        });
    </script>
</body>
</html>