<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅游规划智能体</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Markdown支持 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .markdown-content {
            line-height: 1.8;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.3rem; }
        .markdown-content h3 { font-size: 1.1rem; }
        .markdown-content ul, .markdown-content ol {
            margin-left: 2rem;
            margin-bottom: 1rem;
        }
        .markdown-content li {
            margin-bottom: 0.5rem;
        }
        .progress-bar {
            background-color: #3498db;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="gradient-bg min-h-screen">
        <!-- 语言切换按钮 -->
        <div class="absolute top-4 right-4 z-10">
            <div class="bg-white rounded-lg p-1 shadow-md">
                <button id="langZH" class="px-3 py-2 rounded text-sm font-semibold bg-blue-600 text-white">中文</button>
                <button id="langEN" class="px-3 py-2 rounded text-sm font-semibold text-gray-700 hover:bg-gray-100">English</button>
            </div>
        </div>
        
        <div class="container mx-auto px-4 py-8">
            <!-- 头部 -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">
                    <i class="fas fa-plane-departure mr-3"></i>
                    <span data-lang-key="page-title">旅游规划智能体</span>
                </h1>
                <p class="text-white text-lg opacity-90" data-lang-key="page-subtitle">让AI为您定制完美的旅行计划和旅游咨询</p>
            </div>

            <!-- 功能选择标签 -->
            <div class="flex justify-center mb-6">
                <div class="bg-white rounded-lg p-1 shadow-lg">
                    <button id="planningTab" class="px-6 py-3 rounded-md text-white font-semibold bg-blue-600 transition duration-300">
                        <i class="fas fa-route mr-2"></i><span data-lang-key="tab-planning">旅游规划</span>
                    </button>
                    <button id="consultationTab" class="px-6 py-3 rounded-md text-gray-700 font-semibold hover:bg-gray-100 transition duration-300">
                        <i class="fas fa-question-circle mr-2"></i><span data-lang-key="tab-consultation">旅游咨询</span>
                    </button>
                </div>
            </div>

            <!-- 旅游咨询区域 -->
            <div id="consultationArea" class="max-w-4xl mx-auto mb-8 hidden">
                <div class="result-card rounded-lg p-6 shadow-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <i class="fas fa-comments mr-2"></i><span data-lang-key="consultation-title">旅游咨询</span>
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2" data-lang-key="consultation-label">请输入您想咨询的旅游问题或目的地旅游景区、餐饮等进行</label>
                            <textarea id="consultationQuestion" 
                                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                rows="4" 
                                data-lang-key="consultation-placeholder"
                                placeholder="例如：北京有什么好玩的？上海有哪些必去景点？三亚美食推荐等..."></textarea>
                        </div>
                        <button id="consultationBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            <i class="fas fa-search mr-2"></i><span data-lang-key="consultation-btn">开始咨询</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 输入表单 -->
            <div id="planningArea" class="max-w-4xl mx-auto mb-8">
                <div class="result-card rounded-lg p-6 shadow-xl">
                    <form id="planningForm" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-map-marker-alt mr-2"></i><span data-lang-key="form-departure">出发地</span>
                                </label>
                                <input type="text" id="departure" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                       data-lang-key="departure-placeholder" placeholder="请输入出发城市，如：北京" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-map-marker-alt mr-2"></i><span data-lang-key="form-destination">目的地</span>
                                </label>
                                <input type="text" id="destination" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                       data-lang-key="destination-placeholder" placeholder="请输入目标城市，如：成都" required>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-calendar-alt mr-2"></i><span data-lang-key="form-start-date">出发日期</span>
                                </label>
                                <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-calendar-check mr-2"></i><span data-lang-key="form-end-date">返程日期</span>
                                </label>
                                <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-users mr-2"></i><span data-lang-key="form-travelers">人数</span>
                                </label>
                                <select id="travelers" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="1" data-lang-key="travelers-1">1人</option>
                                    <option value="2" data-lang-key="travelers-2">2人</option>
                                    <option value="3" data-lang-key="travelers-3">3人</option>
                                    <option value="4" data-lang-key="travelers-4">4人</option>
                                    <option value="5+" data-lang-key="travelers-5">5人以上</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-dollar-sign mr-2"></i><span data-lang-key="form-budget">预算范围（元）</span>
                                </label>
                                <select id="budget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="经济型（2000-5000）" data-lang-key="budget-economy">经济型（2000-5000）</option>
                                    <option value="舒适型（5000-10000）" data-lang-key="budget-comfort">舒适型（5000-10000）</option>
                                    <option value="豪华型（10000+）" data-lang-key="budget-luxury">豪华型（10000+）</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-heart mr-2"></i><span data-lang-key="form-preference">旅行偏好</span>
                                </label>
                                <select id="preference" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    <option value="文化历史" data-lang-key="pref-culture">文化历史</option>
                                    <option value="自然风光" data-lang-key="pref-nature">自然风光</option>
                                    <option value="美食体验" data-lang-key="pref-food">美食体验</option>
                                    <option value="休闲度假" data-lang-key="pref-leisure">休闲度假</option>
                                    <option value="冒险刺激" data-lang-key="pref-adventure">冒险刺激</option>
                                    <option value="综合体验" data-lang-key="pref-comprehensive">综合体验</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-comment mr-2"></i><span data-lang-key="form-special">特殊需求（可选）</span>
                            </label>
                            <textarea id="specialRequests" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                      rows="3" data-lang-key="special-placeholder" placeholder="请描述您的特殊需求，如：无障碍设施、素食餐厅、儿童友好等"></textarea>
                        </div>

                        <div class="text-center">
                            <button type="submit" id="generateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 transform hover:scale-105">
                                <i class="fas fa-magic mr-2"></i>
                                <span data-lang-key="generate-btn">生成旅行计划</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 进度显示 -->
            <div id="progressContainer" class="max-w-4xl mx-auto mb-8 hidden">
                <div class="result-card rounded-lg p-6 shadow-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        <span data-lang-key="progress-title">正在生成您的专属旅行计划...</span>
                    </h3>
                    <div class="space-y-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600" data-lang-key="progress-status">初始化中...</p>
                            <p class="text-sm text-blue-600 font-semibold">
                                <span class="progress-percentage">0</span>%
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 结果显示 -->
            <div id="resultContainer" class="max-w-4xl mx-auto hidden">
                <div class="result-card rounded-lg p-6 shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-star mr-2"></i><span data-lang-key="result-title">您的旅行计划</span>
                        </h2>
                        <div class="space-x-2">
                            <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                <i class="fas fa-download mr-2"></i><span data-lang-key="export-btn">导出Markdown</span>
                            </button>
                            <button id="newPlanBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                <i class="fas fa-plus mr-2"></i><span data-lang-key="new-plan-btn">新建计划</span>
                            </button>
                        </div>
                    </div>
                    <div id="resultContent" class="markdown-content prose max-w-none">
                        <!-- 结果内容将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 多语言支持
        const translations = {
            zh: {
                'page-title': '旅游规划智能体',
                'page-subtitle': '让AI为您定制完美的旅行计划和旅游咨询',
                'tab-planning': '旅游规划',
                'tab-consultation': '旅游咨询',
                'consultation-title': '旅游咨询',
                'consultation-label': '请输入您想咨询的旅游问题或目的地旅游景区、餐饮等进行',
                'consultation-placeholder': '例如：北京有什么好玩的？上海有哪些必去景点？三亚美食推荐等...',
                'consultation-btn': '开始咨询',
                'form-departure': '出发地',
                'form-destination': '目的地',
                'form-start-date': '出发日期',
                'form-end-date': '返程日期',
                'form-travelers': '人数',
                'form-budget': '预算范围（元）',
                'form-preference': '旅行偏好',
                'form-special': '特殊需求（可选）',
                'generate-btn': '生成旅行计划',
                'export-btn': '导出Markdown',
                'new-plan-btn': '新建计划',
                'progress-title': '正在生成您的专属旅行计划...',
                'progress-status': '初始化中...',
                'result-title': '您的旅行计划',
                'departure-placeholder': '请输入出发城市，如：北京',
                'destination-placeholder': '请输入目标城市，如：成都',
                'special-placeholder': '请描述您的特殊需求，如：无障碍设施、素食餐厅、儿童友好等',
                'travelers-1': '1人',
                'travelers-2': '2人',
                'travelers-3': '3人',
                'travelers-4': '4人',
                'travelers-5': '5人以上',
                'budget-economy': '经济型（2000-5000）',
                'budget-comfort': '舒适型（5000-10000）',
                'budget-luxury': '豪华型（10000+）',
                'pref-culture': '文化历史',
                'pref-nature': '自然风光',
                'pref-food': '美食体验',
                'pref-leisure': '休闲度假',
                'pref-adventure': '冒险刺激',
                'pref-comprehensive': '综合体验'
            },
            en: {
                'page-title': 'Travel Planning AI Agent',
                'page-subtitle': 'Let AI customize perfect travel plans and tourism consultation for you',
                'tab-planning': 'Travel Planning',
                'tab-consultation': 'Travel Consultation',
                'consultation-title': 'Travel Consultation',
                'consultation-label': 'Please enter your travel questions or inquiries about destinations, attractions, dining, etc.',
                'consultation-placeholder': 'e.g., What are the fun places in Beijing? What are the must-visit attractions in Shanghai? Sanya food recommendations, etc...',
                'consultation-btn': 'Start Consultation',
                'form-departure': 'Departure',
                'form-destination': 'Destination',
                'form-start-date': 'Departure Date',
                'form-end-date': 'Return Date',
                'form-travelers': 'Travelers',
                'form-budget': 'Budget Range (CNY)',
                'form-preference': 'Travel Preference',
                'form-special': 'Special Requirements (Optional)',
                'generate-btn': 'Generate Travel Plan',
                'export-btn': 'Export Markdown',
                'new-plan-btn': 'New Plan',
                'progress-title': 'Generating your exclusive travel plan...',
                'progress-status': 'Initializing...',
                'result-title': 'Your Travel Plan',
                'departure-placeholder': 'Enter departure city, e.g., Beijing',
                'destination-placeholder': 'Enter destination city, e.g., Chengdu',
                'special-placeholder': 'Describe special requirements, e.g., accessibility, vegetarian restaurants, child-friendly, etc.',
                'travelers-1': '1 person',
                'travelers-2': '2 people',
                'travelers-3': '3 people',
                'travelers-4': '4 people',
                'travelers-5': '5+ people',
                'budget-economy': 'Economy (2000-5000 CNY)',
                'budget-comfort': 'Comfort (5000-10000 CNY)',
                'budget-luxury': 'Luxury (10000+ CNY)',
                'pref-culture': 'Culture & History',
                'pref-nature': 'Natural Scenery',
                'pref-food': 'Food Experience',
                'pref-leisure': 'Leisure & Vacation',
                'pref-adventure': 'Adventure & Excitement',
                'pref-comprehensive': 'Comprehensive Experience'
            }
        };

        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8000' : '';
        let currentTaskId = null;
        let currentLang = 'zh'; // 默认中文

        // 语言切换函数
        function switchLanguage(lang) {
            currentLang = lang;
            
            // 更新按钮状态
            document.getElementById('langZH').className = lang === 'zh' 
                ? 'px-3 py-2 rounded text-sm font-semibold bg-blue-600 text-white'
                : 'px-3 py-2 rounded text-sm font-semibold text-gray-700 hover:bg-gray-100';
            document.getElementById('langEN').className = lang === 'en' 
                ? 'px-3 py-2 rounded text-sm font-semibold bg-blue-600 text-white'
                : 'px-3 py-2 rounded text-sm font-semibold text-gray-700 hover:bg-gray-100';
            
            // 更新所有带有 data-lang-key 的元素
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });
            
            // 保存语言选择
            localStorage.setItem('preferredLanguage', lang);
        }

        // 初始化日期和标签切换
        document.addEventListener('DOMContentLoaded', function() {
            // 检查并应用保存的语言设置
            const savedLang = localStorage.getItem('preferredLanguage') || 'zh';
            switchLanguage(savedLang);
            
            // 语言切换事件监听
            document.getElementById('langZH').addEventListener('click', () => switchLanguage('zh'));
            document.getElementById('langEN').addEventListener('click', () => switchLanguage('en'));
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('startDate').valueAsDate = today;
            document.getElementById('endDate').valueAsDate = tomorrow;
            
            // 标签切换功能
            const planningTab = document.getElementById('planningTab');
            const consultationTab = document.getElementById('consultationTab');
            const planningArea = document.getElementById('planningArea');
            const consultationArea = document.getElementById('consultationArea');
            
            // 切换到旅游规划
            planningTab.addEventListener('click', function() {
                planningTab.className = 'px-6 py-3 rounded-md text-white font-semibold bg-blue-600 transition duration-300';
                consultationTab.className = 'px-6 py-3 rounded-md text-gray-700 font-semibold hover:bg-gray-100 transition duration-300';
                planningArea.classList.remove('hidden');
                consultationArea.classList.add('hidden');
            });
            
            // 旅游咨询按钮
            consultationTab.addEventListener('click', function() {
                consultationTab.className = 'px-6 py-3 rounded-md text-white font-semibold bg-blue-600 transition duration-300';
                planningTab.className = 'px-6 py-3 rounded-md text-gray-700 font-semibold hover:bg-gray-100 transition duration-300';
                consultationArea.classList.remove('hidden');
                planningArea.classList.add('hidden');
            });
        });

        // 显示进度
        function showProgress() {
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
        }

        // 隐藏进度
        function hideProgress() {
            document.getElementById('progressContainer').classList.add('hidden');
        }

        // 更新进度
        function updateProgress(percentage) {
            const progressBar = document.querySelector('.progress-bar');
            const progressPercentage = document.querySelector('.progress-percentage');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            if (progressPercentage) {
                progressPercentage.textContent = percentage;
            }
        }

        // 表单提交处理
        document.getElementById('planningForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                departure: document.getElementById('departure').value,
                destination: document.getElementById('destination').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                travelers: document.getElementById('travelers').value,
                budget: document.getElementById('budget').value,
                preference: document.getElementById('preference').value,
                special_requests: document.getElementById('specialRequests').value
            };

            try {
                showProgress();
                updateProgress(10);
                
                const response = await fetch(`${API_BASE_URL}/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requirement: `我想从${formData.departure}到${formData.destination}旅行，从${formData.start_date}到${formData.end_date}，共${formData.travelers}，预算${formData.budget}，偏好${formData.preference}。特殊需求：${formData.special_requests}`,
                        workflow_mode: 'production'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }

                const data = await response.json();
                currentTaskId = data.task_id;
                
                updateProgress(20);
                
                // 开始轮询状态
                pollStatus();
                
            } catch (error) {
                console.error('Error:', error);
                hideProgress();
                alert('生成失败：' + error.message);
            }
        });

        // 旅游咨询处理函数
        document.getElementById('consultationBtn').addEventListener('click', async function() {
            const question = document.getElementById('consultationQuestion').value.trim();
            
            if (!question) {
                alert(currentLang === 'zh' ? '请输入您的旅游咨询问题' : 'Please enter your travel consultation question');
                return;
            }

            try {
                showProgress();
                updateProgress(10);
                
                const response = await fetch(`${API_BASE_URL}/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requirement: question,
                        workflow_mode: 'production'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }

                const data = await response.json();
                currentTaskId = data.task_id;
                
                updateProgress(20);
                
                // 开始轮询状态
                pollConsultationStatus();
                
            } catch (error) {
                console.error('Error:', error);
                hideProgress();
                alert((currentLang === 'zh' ? '咨询失败：' : 'Consultation failed: ') + error.message);
            }
        });

        // 轮询状态
        async function pollStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate/${currentTaskId}/status`);
                const statusData = await response.json();
                
                if (statusData.progress !== undefined) {
                    updateProgress(statusData.progress);
                }
                
                if (statusData.status === 'completed') {
                    let result = statusData.travel_result;
                    if (!result) {
                        const resultResponse = await fetch(`${API_BASE_URL}/api/generate/${currentTaskId}/download`);
                        result = await resultResponse.text();
                    }
                    
                    displayResult(result);
                    hideProgress();
                } else if (statusData.status === 'failed') {
                    hideProgress();
                    throw new Error(statusData.error_details || '生成失败');
                } else {
                    setTimeout(pollStatus, 1000);
                }
            } catch (error) {
                console.error('Error polling status:', error);
                hideProgress();
                alert((currentLang === 'zh' ? '生成失败：' : 'Generation failed: ') + error.message);
            }
        }

        // 轮询咨询状态
        async function pollConsultationStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate/${currentTaskId}/status`);
                const statusData = await response.json();
                
                if (statusData.progress !== undefined) {
                    updateProgress(statusData.progress);
                }
                
                if (statusData.status === 'completed') {
                    let result = statusData.travel_result;
                    if (!result) {
                        const resultResponse = await fetch(`${API_BASE_URL}/api/generate/${currentTaskId}/download`);
                        result = await resultResponse.text();
                    }
                    
                    displayResult(result);
                    hideProgress();
                } else if (statusData.status === 'failed') {
                    hideProgress();
                    throw new Error(statusData.error_details || '咨询处理失败');
                } else {
                    setTimeout(pollConsultationStatus, 1000);
                }
            } catch (error) {
                console.error('Error polling consultation status:', error);
                hideProgress();
                alert((currentLang === 'zh' ? '咨询处理失败：' : 'Consultation failed: ') + error.message);
            }
        }

        // 显示结果
        function displayResult(result) {
            const resultDiv = document.getElementById('resultContent');
            
            try {
                const htmlContent = marked.parse(result);
                const sanitizedContent = DOMPurify.sanitize(htmlContent);
                
                resultDiv.innerHTML = sanitizedContent;
                
                const resultContainer = document.getElementById('resultContainer');
                if (resultContainer) {
                    resultContainer.classList.remove('hidden');
                    resultContainer.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('显示结果时出错:', error);
                resultDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded">${currentLang === 'zh' ? '显示结果时出错' : 'Error displaying result'}: ${error.message}</div>`;
            }
        }

        // 导出Markdown
        document.getElementById('exportBtn').addEventListener('click', function() {
            const content = document.getElementById('resultContent').innerHTML;
            
            let markdown = content
                .replace(/<h1>/g, '# ')
                .replace(/<\/h1>/g, '\n\n')
                .replace(/<h2>/g, '## ')
                .replace(/<\/h2>/g, '\n\n')
                .replace(/<h3>/g, '### ')
                .replace(/<\/h3>/g, '\n\n')
                .replace(/<ul>/g, '')
                .replace(/<\/ul>/g, '\n')
                .replace(/<li>/g, '- ')
                .replace(/<\/li>/g, '\n')
                .replace(/<strong>/g, '**')
                .replace(/<\/strong>/g, '**')
                .replace(/<em>/g, '*')
                .replace(/<\/em>/g, '*')
                .replace(/<p>/g, '')
                .replace(/<\/p>/g, '\n\n')
                .replace(/&nbsp;/g, ' ')
                .replace(/\n\s*\n\s*\n/g, '\n\n');

            markdown += `\n\n---\n\n本旅游规划由 [gitagent.io](https://gitagent.io) 智能旅游规划系统生成\n\n🌐 访问我们：[https://gitagent.io](https://gitagent.io)`;

            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const isConsultation = markdown.includes('旅游咨询回答');
            const filePrefix = isConsultation ? (currentLang === 'zh' ? '旅游咨询' : 'Travel_Consultation') : (currentLang === 'zh' ? '旅行计划' : 'Travel_Plan');
            a.download = `${filePrefix}_${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // 新建计划
        document.getElementById('newPlanBtn').addEventListener('click', function() {
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('planningForm').reset();
            document.getElementById('consultationQuestion').value = '';
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('startDate').valueAsDate = today;
            document.getElementById('endDate').valueAsDate = tomorrow;
        });
    </script>
</body>
</html>